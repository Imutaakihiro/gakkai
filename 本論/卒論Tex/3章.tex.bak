\chapter{GNL モデルの情報理論的解釈}
\def\thesection{\thechapter.\arabic{section}}
\setcounter{section}{0} 
\section{3 章の目的}

マーケティングにおける離散選択においては，MNL や NL モデルに代表される離散選択モデル，エントロピー・モデルが広く用いられている．
前者は 2 章で示したように経済学における効用最大化と整合的であり，後者は情報理論における情報量最小化（エントロピー最大化）と整合的である．
つまり，前者は（ランダム）効用を最大化するように選択肢を決定し，後者は情報量を最小化するように選択確率を決定していることとなる．

一部のモデルにおいては，この両者は等価であることが知られている．
基本となる MNL モデルでは Roy and Lesse (1981) \cite{RL81}が，
その発展形となる NL モデルでは Roy and Lesse (1985) \cite{RL85} が，集計的に等価であることを証明している．
さらに注目すべき事実として，Anas (1983) \cite{Ana83} は非集計離散選択モデル，エントロピー・モデルこの両者が，非集計レベルで等価であることを示している．
具体的には，MNL モデルの対数尤度最大化問題が制約条件付エントロピー最大化問題と等価であるとしている．

本章では，GNL モデルについて，MNL，NL モデルと同様に，集計的，非集計的にエントロピー・モデルと等価であることを示す．
これにより，エントロピー・モデルにおいて効用最大化と整合的であるクラスが明らかになり，意味づけが容易となる．
また，GNL モデルの情報理論的解釈が可能となる．
本研究により明らかとなる等価性の範囲は，表\ref{tb:3-1}の非集計の箇所全てに相当する．
この表内のうち，記載がある箇所が既存研究の範囲であり，何も記載がない箇所が本研究独自の箇所である．
GNL モデルは MNL, NL, CNL の各モデルを内包するため，非集計全ての範囲において等価性を示すこととなる．
\begin{table*}[t!]
\begin{center}
\caption{本章により明らかとなる離散選択モデルの等価性の範囲}  \label{tb:3-1}
\begin{tabular} {ccccc}
\toprule
& \makebox[3.9cm][c]{MNL} & \makebox[3.9cm][c]{NL}  & \makebox[3.9cm][c]{CNL, GNL} \\
\hline\hline
\multirow{1}{*}{集計} & \multirow{2}{*}{Roy \& Lesse(1981)\cite{RL81}}& \multirow{2}{*}{Roy \& Lesse(1985)\cite{RL85}} & Prashker \& Bekhor(1999)\cite{PB99}$^{\ast}$\\
&&& Bekhor \& Prashker(2001)\cite{BP01}$^{\ast}$\\
& & &\\\hline
非集計 &Anas(1983)\cite{Ana83}& & \\ 
\bottomrule
\multicolumn{4}{l}{$\ast$ 正確には，確率的利用者均衡配分問題\cite{Fis80}との等価性である．}
\end{tabular}
\end{center}
\end{table*}

集計的な等価性については，集計 GNL モデルがエントロピー制約付き最大化問題に帰着することを示す．
そして，集計単位を個人としたとき，価値最大化問題として，GNL モデルが捉えられることを示す．

非集計的な等価性では，主問題として与えられる GNL モデルの Full Information Maximum Likelihood (FIML) の対数尤度関数が凸ではないため，双対問題として明らかに等価最適化問題を構成することはできない．
これは，GNL モデルだけではなく，NL モデルにおいても同様である．
そのため，本研究では一般的に NL モデルで用いられている二段階推定法（例えばBen-Akiva and Lerman, 1985 \cite{BL85}; Train 2009 \cite{Tra09}）により，二段階の各段階の問題がそれぞれ等価なエントロピー問題として表わされ，それが入れ子として構成されることを示す．
また，情報理論的解釈により，GNL モデルの段階的パラメータ推定時における，各パラメータと段階との理論的対応を明らかにする．
パラメータ推定と等価なエントロピー問題の結果より，Vovsha (1997)\cite{Vov97} で提案されている，GNL モデルのヒューリスティックなパラメータ推定方法を改良し，この解釈に基づく GNL モデルのパラメータ推定アルゴリズムを提案する．
さらに双対性という特徴に着目したアルゴリズムも提案する．

本章の構成は次のとおりである．
2 節では，集計レベルの GNL モデルとエントロピー・モデルの等価性を示す．
3 節では，非集計レベルの GNL モデルとエントロピー・モデルの等価性を示す．
最後に 4 節で本章のまとめを示す．

%****************************************************************************************************************************************
\section{集計レベルにおけるエントロピー・モデルとの等価性}
\subsection{集計 GNL モデル}
集計 GNL モデルは，次のように表される：\\
{\sf[O-GNL-{$\A$}]}
\begin{align}
P_k^{\A} &=  \sum \limits_{j^{\prime}=1}^{N_j} P_{j^{\prime}}^{\A} P_{k|j^{\prime}}^{\A},\label{eq3-1}\\
P_j^{\A} &=  \frac{\left( \sum \limits_{k^{\prime} \in {\cal K}_j} \left(\gamma_{k^{\prime}j}^{\A} \exp{V_{k^\prime}^{\A}} \right)^{1/\mu_j^{\A}}\right)^{\mu_j^{\A}}}
{\sum \limits_{j^{\prime}=1}^{N_j} {\left( \sum \limits_{k^{\prime} \in {\cal K}_{j^{\prime}}} \left(\gamma_{k^{\prime}j^{\prime}}^{\A} \exp{V_{k^\prime}^{\A}} \right)^{1/\mu_{j^{\prime}}^{\A}}\right)^{\mu_{j^{\prime}}^{\A}}}},\label{eq3-2}\\
P_{k|j}^{\A}  &=  \frac{\left( \gamma_{kj}^{\A} \exp{V_k}^{\A} \right)^{1/\mu_j^{\A}}}
{\sum \limits_{k^{\prime} \in {\cal K}_j} \left( \gamma_{k^{\prime}j}^{\A} \exp{V_{k^\prime}^{\A}} \right)^{1/\mu_j^{\A}}},~~\forall k,j \label{eq3-3}
\end{align}
ここで，上付きの $\A$ は集計した場合を表わし，$P_k^{\A}$，$P_j^{\A}$，$P_{k|j}^{\A}$ は，単なる選択確率ではなく，期待選択確率もしくは，割合である．
パラメータの制約条件は式\eqref{eq2-34}--\eqref{eq2-36} と同様である：
\begin{align}
0< \mu_j ^{\A}&\leq 1,&\forall& j, \label{eq3-4}\\
\gamma_{kj}^{\A}\geq& 0,&\forall& j,k, \label{eq3-5}\\
\sum \limits_{j^{\prime}}^{N_j} \gamma_{kj^{\prime}}^{\A}=&1, &\forall& k. \label{eq3-6}
\end{align}

集計 GNL モデルは，マーケット・シェアのように，日次データ等の集計的なデータのみしか得ることができない場合に有効な方法\cite{LW83,HRG05}である．
ただし，一般的な最尤推定法により推定されたパラメータ同士は異なること：
\begin{align}
\overline{{\bm \theta}}^{\ast} &\not = \overline{{\bm \theta}}^{\A \ast} \label{eq3-7}
\end{align}
に注意されたい．ここで，${\bm \theta}$ はパラメータ集合，上添字 $\ast$ 及びオーバーラインは最尤推定されたことを表す．

\subsection{数理計画問題：エントロピー・モデル}
式\eqref{eq3-1}--\eqref{eq3-3} で表わされる集計 GNL モデルの選択確率 {\sf[O-GNL-$\A$]} は，次に示す数理計画問題（エントロピー・モデル）{\sf[MP-GNL-$\A$]} と等価である：\\
{\sf[MP-GNL-$\A$]}
\begin{align}
\mathcal {E}:&= \inf \limits_{P_{jk}^{\A}} \left[ - \sum_{j^{\prime}=1}^{N_j} \sum_{k^{\prime}=1}^{N_k} P_{j^{\prime}k^{\prime}}^{\A} V_{k^{\prime}}^{\A} + \sum_{j^{\prime}=1}^{N_j} \sum_{k^{\prime}=1}^{N_k} \mu_{j^{\prime}}^{\A} P_{j^{\prime}k^{\prime}}^{\A} \ln \frac{P_{j^{\prime}k^{\prime}}^{\A}}{\gamma_{k^{\prime}j^{\prime}}^{1/\mu_{j^{\prime}}^{\A}}} \right. \notag\\
&~~~~~~+\left. \sum_{j^{\prime}=1}^{N_j} \left\{ \left(1- \mu_{j^{\prime}}^{\A} \right) \left( \sum_{k^{\prime}=1}^{N_k} P_{j^{\prime}k^{\prime}}^{\A} \right) \ln \left( \sum_{k^{\prime}=1}^{N_k} P_{j^{\prime}k^{\prime}}^{\A} \right) \right\} \right] := Z_1 + Z_2 + Z_3 \label{eq3-8}\\
{\rm s.t.}\notag\\
&\sum_{j^{\prime}=1}^{N_j} \sum_{k^{\prime}=1}^{N_k} P_{j^{\prime}k^{\prime}}^{\A} = 1, \label{eq3-9}\\
&{\rm if}~P_{jk}^{\A} = 0~{\rm or}~\gamma_{kj}^{\A} = 0 \Rightarrow P_{jk}^{\A} \ln \frac{P_{jk}^{\A}}{(\gamma_{kj}^{\A})^{1/\mu_j^{\A}}}=0. \label{eq3-10}
\end{align}
ここで，$P_{jk}^{\A}$ は集団 $\A$ がネスト $j$ により選択肢 $k$ を選ぶ割合である．

式\eqref{eq3-8}は，3つの項に大きく分けることができる．最初の項 ($Z_1$) は社会的効用最大化行動を示し，2番目 ($Z_2$) ，3番目 ($Z_3$) の項は $Z_1$ にエントロピー制約をかけていると解釈できる．
そして，それらの割合は $\mu_j : 1-\mu_j$ の割合となっていると解釈できる．
また，$Z_2$は選択肢 $k$ ，$Z_3$ はネスト $j$ にそれぞれ相当するエントロピー制約である．
最後に，式\eqref{eq3-9}は，$P_{jk}$ が割合であるための条件である．

ここで注目すべき点は，各 $j$--$k$ 間の構造に，この数理計画問題が触れていない点である．
これは，割合 $P_{jk}^{\A}$ が内生的に $0$ となることでもたらされる．つまりは数理計画問題の解として GNL モデルの構造推定が可能であることを示唆している．
%****************************************************************************************************************************************
\subsection{集計レベルの等価性の証明}
\begin{proposition}[集計レベルの等価性]
式\eqref{eq3-8}--\eqref{eq3-10}で表される数理計画問題 {\sf[MP-GNL-$\A$]} と，式\eqref{eq3-1}--\eqref{eq3-3} で表される GNL モデルに基づく選択割合 {\sf[O-GNL-$\A$]} は等価である．
\end{proposition}
\begin{proof}
補題\ref{le1}より，式\eqref{eq3-8}--\eqref{eq3-10}で表される数理計画問題 {\sf[MP-GNL-$\A$]} の解として式\eqref{eq3-1}--\eqref{eq3-3} GNL にモデル基づく選択割合 {\sf[O-GNL-$\A$]} が存在し，
補題\ref{le2}より，それが一意である．したがって，両者は等価である．\QED
\end{proof}

\begin{lemma}[存在条件] \label{le1}
式\eqref{eq3-8}--\eqref{eq3-10} で表される数理計画問題 {\sf[MP-GNL-$\A$]} の解として，式\eqref{eq3-1}--\eqref{eq3-3}で表される GNL モデルに基づく選択割合 {\sf[O-GNL-$\A$]} が存在する．
\end{lemma}
\begin{proof}
式\eqref{eq3-8}--\eqref{eq3-10}に対応するラグランジアン $\Lambda$ は，
\begin{align}
\Lambda :=& Z_1 + Z_2 + Z_3 + \lambda \left(\sum \limits_{k^{\prime}=1}^{N_k} P_{jk^{\prime}}^{\A} -1 \right) \label{eq3-11}
\end{align}
となる．ここで $\lambda$ は，式\eqref{eq3-9}に対応したラグランジェ乗数である．
式\eqref{eq3-10}については，$Z_2$ 内に反映されているため，特にラグランジェ乗数は必要としない．
$Z_1$--$Z_3$ 各項の$P_{jk}^{\A}$ による偏微分は次のとおりとなる：
\begin{align}
\frac{\partial Z_1}{\partial P_{jk}^{\A}} &= -V_k^{\A},&\forall j,k, \label{eq3-12}\\
\frac{\partial Z_2}{\partial P_{jk}^{\A}} &= \mu_j^{\A} \ln \frac{P_{jk}^{\A}}{(\gamma_{kj}^{\A})^{1/\mu_j}} + \mu_j^{\A} ,&\forall j,k, \label{eq3-13}\\
\frac{\partial Z_3}{\partial P_{jk}^{\A}} &= \left( 1 - \mu_j^{\A} \right) \ln \left( \sum_{k^{\prime}=1}^{N_k} P_{jk^{\prime}}^{\A} \right) + 1- \mu_j^{\A}, &\forall j,k. \label{eq3-14}
\end{align}
ここで，式\eqref{eq3-11}--\eqref{eq3-14}より，
\begin{align}
P_{jk}^{\A} \left( \sum_{k^{\prime}=1}^{N_k} P_{jk^{\prime}}^{\A} \right)^{\frac{1-\mu_j^{\A}}{\mu_j^{\A}}} =& \exp \left\{ (\lambda-1)/\mu_j^{\A} \right\} (\gamma_{kj}^{\A})^{1/\mu_j^{\A}} \exp \left(V_k^{\A} /\mu_j^{\A} \right) \label{eq3-15}
\end{align}
を得る．両辺を選択肢 $k$ で足し上げると，
\begin{align}
\left( \sum_{k^{\prime}=1}^{N_k} P_{jk^{\prime}}^{\A} \right)^{\frac{1}{\mu_j^{\A}}} &= \exp \left\{ ( \lambda - 1 ) / \mu_j^{\A} \right\} \left\{ \sum_{k^{\prime}=1}^{N_k} (\gamma_{k^{\prime}j}^{\A})^{1/\mu_j^{\A}} \exp \left(V_{k^{\prime}}^{\A} /\mu_j^{\A} \right) \right\} \label{eq3-16}
\end{align}
を得る．次に，ここで両辺を $\mu_j^{\A}$ 乗すると，
\begin{align}
\sum_{k^{\prime}=1}^{N_k} P_{jk^{\prime}}^{\A} &= \exp \left\{ ( \lambda - 1 ) / \mu_j^{\A} \right\} \left\{ \sum_{k^{\prime}=1}^{N_k} (\gamma_{k^{\prime}j}^{\A})^{1/\mu_j^{\A}} \exp \left(V_{k^{\prime}}^{\A}/\mu_j^{\A} \right) \right\}^{\mu_j^{\A}} \label{eq3-17}
\end{align}
を得る．さらに，両辺をネスト $j$ で足し上げると．
\begin{align}
\sum_{j^{\prime}=1}^{N_j} & \sum_{k^{\prime}=1}^{N_k} P_{j^{\prime}k^{\prime}}^{\A} = \exp(\lambda-1) \sum_{j^{\prime}=1}^{N_j} \left\{ \sum_{k^{\prime}=1}^{N_k} (\gamma_{k^{\prime}j^{\prime}}^{\A})^{1/\mu_{j^{\prime}}^{\A}} \exp (V_{k^{\prime}}^{\A} / \mu_{j^{\prime}}^{\A}) \right\}^{\mu_{j^{\prime}}^{\A}} =1 \label{eq3-18}
\end{align}
となる．ここで，式\eqref{eq3-17}を\eqref{eq3-18}で割ることにより，
\begin{align}
P_j^{\A}= \sum_{k^{\prime}=1}^{N_k} P_{jk^{\prime}}^{\A} = \frac{\left( \sum \limits_{k^{\prime}=1}^{N_k} \left(\gamma_{k^{\prime}j}^{\A} \exp{V_{k^{\prime}}^{\A}}\right)^{1/\mu_j^{\A}}\right)^{\mu_j^{\A}}}
{\sum \limits_{j^{\prime}=1}^{N_j} \left( \sum \limits_{k^{\prime}=1}^{N_k} \left(\gamma_{k^{\prime}j^{\prime}}^{\A} \exp{V_{k^{\prime}}^{\A}}\right)^{1/\mu_{j^{\prime}}^{\A}}\right)^{\mu_{j^{\prime}}^{\A}}}\label{eq3-19}
\end{align}
を得る．最後に，選択肢 $k$ が有さないネスト $j$ への帰属を排除，すなわち式\eqref{eq3-10} を用い， $\sum_{k^{\prime}=1}^{N_k}$ を $\sum_{k^{\prime} \in {\cal K}_j}$ とすると，
\begin{align}
P_j^{\A}= \frac{\left( \sum \limits_{k^{\prime} \in {\cal K}_j} \left(\gamma_{k^{\prime}j}^{\A} \exp{V_{k^\prime}^{\A}}\right)^{1/\mu_j^{\A}}\right)^{\mu_j^{\A}}}
{\sum \limits_{j^{\prime}=1}^{N_j} {\left( \sum \limits_{k^{\prime} \in {\cal K}_{j^{\prime}}} \left(\gamma_{k^{\prime}j^{\prime}}^{\A} \exp{V_{k^\prime}^{\A}}\right)^{1/\mu_{j^{\prime}}^{\A}}\right)^{\mu_{j^{\prime}}^{\A}}}}\label{eq3-20}
\end{align}
を得る．ここで，$\sum_{k^{\prime}=1}^{N_k}$ を $\sum_{k^{\prime} \in {\cal K}_j}$ としても，式\eqref{eq3-10}より，$P_{jk}^{\A}=0$ もしくは $\gamma_{kj}^{\A}=0$ の場合，$P_{jk}^{\A} \ln (P_{jk}^{\A}/(\gamma_{kj}^{\A})^{1/\mu_j^{\A}})=0$ としているため，対応は問題ない．

同様に，式\eqref{eq3-15}を\eqref{eq3-16}で割ることにより，条件付き確率 $P_{k|j}^{\A}$ は
\begin{align}
P_{k|j}^{\A} = \frac{P_{jk}^{\A}}{\sum_{k^{\prime}=1}^{N_k} P_{jk}^{\A}} = \frac{\left( \gamma_{kj}^{\A} \exp{V_k}^{\A} \right)^{1/\mu_j^{\A}}}
{\sum \limits_{k^{\prime}=1}^{N_k} \left( \gamma_{k^{\prime}j}^{\A} \exp{V_{k^{\prime}}^{\A}} \right)^{1/\mu_j^{\A}}} \label{eq3-21}
\end{align}
となる．ここで，$P_j^{\A}$ の場合と同様に $\sum_{k^{\prime}=1}^{N_k}$ を $\sum_{k^{\prime} \in {\cal K}_j}$ とすると
\begin{align}
P_{k|j}^{\A} = & \frac{\left( \gamma_{kj}^{\A} \exp{V_k^{\A} }\right)^{1/\mu_j^{\A}}}
{\sum \limits_{k^{\prime} \in {{\cal K}_j}} \left( \gamma_{k^{\prime}j}^{\A} \exp{V_{k^\prime}^{\A}}\right)^{1/\mu_j^{\A}}} \label{eq3-22}
\end{align}
を得る．

式\eqref{eq3-20}，\eqref{eq3-22}はそれぞれ，GNL モデルにおける各選択確率（割合）式\eqref{eq3-2}，\eqref{eq3-3}に対応している．
以上より，式\eqref{eq3-8}--\eqref{eq3-10}の解として，GNL モデルに基づく選択割合が導かれた．\QED
\end{proof}
\begin{lemma}[一意性] \label{le2}
式\eqref{eq3-8}--\eqref{eq3-10}の解は，一意に定まる．
\end{lemma}
\begin{proof}
式\eqref{eq3-8}の各項のヘシアンの各成分について調べよう：
\begin{align}
\frac{\partial^2 Z_2}{\partial P_{jk}^{\A} \partial P_{jk^{\prime}}^{\A}}&= \left\{
\begin{array}{ll}
\frac{\mu_j}{P_{jk}^{\A}} & k=k^{\prime} \\
0 & {\rm otherwise}
\end{array}
\right., \label{eq3-23}\\
\frac{\partial^2 Z_3}{\partial P_{jk}^{\A} \partial P_{jk^{\prime}}^{\A}}&= \left\{
\begin{array}{ll}
\frac{1-\mu_j^{\A}}{\sum_{k^{\prime}=1}^{N_k} P_{jk^{\prime}}^{\A}}& P_{jk}^{\A},P_{jk^{\prime}}^{\A} >0 \\
0 & {\rm otherwise}
\end{array}
\right. . \label{eq3-24}
\end{align}
ここで，式\eqref{eq3-4} 及び $P_{jk}\geq0$ より，$\nabla^2 Z_2$ の各対角要素は正となり，$\nabla^2 Z_2$ は正定値行列となる．
同様に 式\eqref{eq3-4} 及び $P_{jk}\geq0$ より，$\nabla^2 Z_3$ についても各 $j$--$k$ ペアごとに各要素は正の定数となる．
$\nabla^2 Z_3$の要素を$\chi_{x,y}$と要素表示するとすると，
\begin{align}
\chi_{x,x}\geq \chi_{x,y},~\forall y\not=x,\label{eq3-25}\\
\chi_{y,y}\geq \chi_{x,y},~\forall x\not=y \label{eq3-26}
\end{align}
である．したがって，$\nabla^2 Z_3$ の固有値は非負であり，$\nabla^2 Z_3$ は半正定値行列である．
以上より，式\eqref{eq3-8}は $P_{jk}^{\A}$ に関して凸性があり，一意な解\eqref{eq3-20}，\eqref{eq3-22} をもつ．\QED
\end{proof}
\subsection{非集計レベルへの対応}
集計レベルと同様に，非集計レベルの選択確率もエントロピー制約付き最大化問題へと変換できる．
これは，明らかに 式\eqref{eq3-8}--\eqref{eq3-10} の問題において $\A$ を $h$ とすればよい：\\
{\sf[MP-GNL $h$]}
\begin{align}
\mathcal {E}:&= \inf \limits_{P_{jk}^{h}} \left[ - \sum_{j^{\prime}=1}^{N_j} \sum_{k^{\prime}=1}^{N_k}  P_{j^{\prime}k^{\prime}}^{h} V_{k^{\prime}}^{h} + \sum_{j^{\prime}=1}^{N_j} \sum_{k^{\prime}=1}^{N_k} \mu_{j^{\prime}} P_{j^{\prime}k^{\prime}}^{h} \ln \frac{P_{j^{\prime}k^{\prime}}^{h}}{\gamma_{k^{\prime}j^{\prime}}^{1/\mu_{j^{\prime}}}} \right. \notag\\
&~~~~~~~~~+\left. \sum_{j^{\prime}=1}^{N_j} \left\{ \left(1- \mu_{j^{\prime}} \right) \left( \sum_{k^{\prime}=1}^{N_k} P_{j^{\prime}k^{\prime}}^{h} \right) \ln \left( \sum_{k^{\prime}=1}^{N_k} P_{j^{\prime}k^{\prime}}^{h} \right) \right\} \right] \label{eq3-27}\\
{\rm s.t.}\notag\\
&\sum_{j^{\prime}=1}^{N_j} \sum_{k^{\prime}=1}^{N_k} P_{j^{\prime}k^{\prime}}^{h} = 1,~~\forall h \label{eq3-28}\\
&{\rm if}~P_{jk}^{h} = 0~{\rm or}~\gamma_{kj} = 0 \Rightarrow P_{jk}^{h} \ln \frac{P_{jk}^{h}}{(\gamma_{kj})^{1/\mu_j}}=0,~~\forall k,j,h. \label{eq3-29}
\end{align}
ただし，ここで，$P_{jk}$ は割合ではなく，確率である．
式\eqref{eq3-27}--\eqref{eq3-29} は，個人の行動が選択確率を決めることによる，エントロピー制約付き最小化（最大化），Value Maximizing 問題として表現できることを意味する．
GNL モデルが内包している各 GEV モデルの等価数理最適化問題は，高橋・大野 (2012) \cite{TO12} を参照せよ．
%****************************************************************************************************************************************
%\section{GNL に内包される各モデルと等価なエントロピー・モデル}
%ここでは，GNL に内包される MNL，NL，CNL，PCL の各モデルと等価な数理計画問題（エントロピー・モデル）を示す．
%
%\subsection{MNL}
%GNL を MNL に分解する方法はネストとなっている一段階目を残す方法と，二段階目を残す方法がある．
%本節ではその両方を示そう．
%\subsubsection{$\mu_j\rightarrow 0$の場合}
%この場合，エントロピー制約（$Z_2$，$Z_3$）のうち $Z_2$ が消去され，ブランド $k$ を直接選択することとなる．
%すなわち，等価数理計画問題は，\\
%{\sf[MP-MNL-$k$]}
%\begin{align}
%\mathcal {E}:&= \inf \limits_{P_{k}} \left\{ - \sum_k  P_{k} V_k + P_{k} \ln P_{k} \right\} \label{eq3-51}\\
%&{\mathrm s.t.}~\sum_k P_{k} = 1
%\end{align}
%となる．
%\subsubsection{$\mu_j\rightarrow 1$の場合}
%この場合，エントロピー制約（$Z_2$，$Z_3$）のうち $Z_3$ が消去され，商品構成要素 $j$ を残置することとなる．
%また，$\gamma_{kj}=0$ or $1~\forall j$となり，等価数理計画問題は，\\
%{\sf[MP-MNL-$j$]}
%\begin{align}
%\mathcal {E}:&= \inf \limits_{P_{j}} \left\{ - \sum_j  P_{j} V_j + P_{j} \ln P_{j} \right\} \label{eq3-52}\\
%&{\mathrm s.t.}~\sum_j P_{j} = 1
%\end{align}
%となる．
%\subsection{NL}
%この場合，全てのブランド $k$ はどれか一つの商品構成要素 $j$ に属することから，$\gamma_{kj}=0$ or $1~\forall k$ となる．
%等価数理計画問題は，\\
%{\sf[MP-NL]}
%\begin{align}
%\mathcal {E}:&= \inf \limits_{P_{jk}} \left\{ - \sum_j \sum_k P_{jk} V_k + \sum_j \sum_k \mu_j P_{jk} \ln {P_{jk}} \right. \notag\\
%&+\hspace{-1.0mm} \left. \sum_j \left(1-\mu_j \right) \hspace{-1.0mm} \left( \sum_k P_{jk} \right) \ln \hspace{-1.0mm} \left( \sum_k P_{jk} \right) \right\} \label{eq3-53}\\
%&{\mathrm s.t.}~\sum_{j} \sum_k P_{jk} =1
%\end{align}
%となる．
%\subsection{CNL}
%CNL は GNL の類似度パラメータを全て同一としたモデルである．すなわち単に $\mu_j=\mu~\forall j$ とすればよい．
%等価数理計画問題は割愛する．
%\subsection{PCL}
%PCLは，各選択枝を一対比較するようにネストを構成するモデルであり，Chu\cite{Chu81, Chu89}により提案された．
%PCLは，一対比較を行なうため，各ネストには二つの選択肢が所属し，ネスト数 $J$ は，選択肢数を $K$ とすると，
%$J=K^2/2$となる．等価数理計画問題は，総当りでネストを構成するため，
%{\sf[MP-PCL]}
%\begin{align}
%\mathcal {E}:&= \inf \limits_{P_{jk}} \left\{ - \sum_{j=1}^{K-1} \sum_{k=j+1}^{K} P_{jk} V_k + \sum_{j=1}^{K-1} \sum_{k=j+1}^{K} \mu_j P_{jk} \ln {P_{jk}} \right. \notag\\
%&+\hspace{-1.0mm} \left. \sum_{j=1}^{K-1} \left(1-\mu_j \right) \hspace{-1.0mm} \left( \sum_{k=j+1}^{K} P_{jk} \right) \ln \hspace{-1.0mm} \left( \sum_{k=j+1}^{K} P_{jk} \right) \right\} \label{eq3-54}\\
%&{\rm s.t.}~\sum_{j} \sum_k P_{jk} =1
%\end{align}
%と書き下せる．
%****************************************************************************************************************************************
\section{非集計レベルにおけるエントロピー・モデルとの等価性}
%****************************************************************************************************************************************
本節では，GNL モデルの段階的パラメータ最尤推定問題が段階的エントロピー・モデルとして表わされることを示そう．
同質な消費者 $h$ を考えよう．そして，ネスト $j$ を持つ選択肢 $k$ が存在するものとする．
ここで，同じ選択肢 $k$ はある特定のネスト $j^\prime$ には複数の帰属を許さないものとする．
選択肢 $k$ の効用 $U_{k}$ は，線形の関数である\footnote{線形でなくともよいが，パラメータ推定時により高い非線形性が生ずる\cite{TMB87}．}とし，その効用関数は選択肢 $k$ の説明変数の値に依存するものとする：
\begin{equation}
U_{k}^h = \sum_{m^{\prime}=1}^{N_m} \alpha_{m^{\prime}} X_{km^{\prime}} +  \alpha_{0k} + \epsilon_{jk} := V_{k}^h + \epsilon_{k}. \label{eq3-30}
\end{equation}
ここで，$X_{km}$ は選択肢 $k$ の $m$ 番目の説明変数，$\alpha_{m}$ は対応するパラメータ，$\alpha_{0k}$ は固有選好度，
$\epsilon_{k}$ は確率的効用である．
$V_{k}$ は確定的効用と捉えることができる．
消費者を同質であると仮定したため，添え字 $h$ は必要がない限り省略する．
%****************************************************************************************************************************************
\subsection{主問題：段階的パラメータ最尤推定問題}
式\eqref{eq2-48}--\eqref{eq2-50}で表されるGNL モデルにおけるパラメータの段階推定対数尤度最大化問題 {\sf{[Primal-}${\cal L}${\sf]}} は，\\
{\sf{[Primal-}${\cal L}${\sf]}}
\begin{align}
&{\sf{[Step~1]}}\notag\\
&{{\cal L}_1} := \max_{\substack{ \overline{\alpha}_m \forall m \\ \overline{\alpha}_{0k} \forall k \\ \overline{\gamma}_{kj} \forall (k,j)}} \sum_{h^{\prime}=1}^{N_h} \sum_{j^{\prime}=1}^{N_j} \sum_{k^{\prime} \in {\cal K}_{j^{\prime}}} \delta_{k^{\prime}}^{h^{\prime}} \ln P_{k^{\prime}|j^{\prime}}^{h^{\prime}} ( \overline{\alpha}_{m^{\prime}}, \overline{\alpha}_{0k^{\prime}},\overline{\gamma}_{k^{\prime}j^{\prime}} ), \label{eq3-31}\\
&{\sf{[Step~2]}}\notag\\
&{{\cal L}_2} := \max_{\overline{\mu}_j \forall j} \left\{ \sum_{h^{\prime}=1}^{N_h} \sum_{j^{\prime}=1}^{N_j} \delta_{j^{\prime}}^{h^{\prime}} \ln P_{j^{\prime}}^{h^{\prime}} ( \overline{\mu}_{j^{\prime}} ) \Bigg| {\cal L}_1^{\ast} \right\} \label{eq3-32}
\end{align}
となる．ここで，$N_h$ は消費者数もしくはサンプル数，$\delta_j^h$，$\delta_{k}^h$はそれぞれ消費者 $h$ がネスト $j$ ，選択肢 $k$ を選択した場合 $1$，それ以外は $0$ を示す二値変数であり，変数上のラインは明示的にパラメータを推定することを意味する．
また，$P_k^h$，$P_j$，$P_{k|j}^h$ はそれぞれ式\eqref{eq2-42}--\eqref{eq2-44} で表わされる GNL モデルの選択確率式である．
${\sf{[Step~1]}}$ では，ネスト $j$ に関する情報，すなわち類似度パラメータ $\mu_j$ について与件とし，$\overline{\alpha}_m$，$\overline{\alpha}_{0k}$，$\overline{\gamma}_{kj}$ を推定する．
次に，${\sf{[Step~2]}}$ において ${\sf{[Step~1]}}$ で最尤推定されたパラメータ $\overline{\alpha}_m^{*}$，$\overline{\alpha}_{0k}^{*}$，$\overline{\gamma}_{kj}^{*}$ を与件とし，$\overline{\mu}_j$ を最尤推定する．

式\eqref{eq3-31}，\eqref{eq3-32}の最大化の一階条件より，
\begin{align}
&\frac{\partial {\cal L}_1}{\partial \overline{\alpha}_m}=0  \Longrightarrow \sum_{h^{\prime}=1}^{N_h} \sum_{j^{\prime}=1}^{N_j} \sum_{k^{\prime} \in {\cal K}_{j^{\prime}}} \delta_{k^{\prime}|j^{\prime}}^{h^{\prime}} \frac{X_{k^{\prime}m}}{\mu_{j^{\prime}}} = \sum_{h^{\prime}=1}^{N_h} \sum_{j^{\prime}=1}^{N_j} \sum_{k^{\prime} \in {\cal K}_{j^{\prime}}} P_{k^{\prime}|j^{\prime}}^{h^{\prime}} \frac{X_{k^{\prime} m}}{\mu_{j^{\prime}}},&\forall m, \label{eq3-33}\\
&\frac{\partial {\cal L}_1}{\partial \overline{\alpha}_{0k}}=0  \Longrightarrow \sum_{h^{\prime}=1}^{N_h} \sum_{j^{\prime}=1}^{N_j} \frac{ \delta_{k^{\prime}|j^{\prime}}^{h^{\prime}}}{\mu_{j^{\prime}}} = \sum_{h^{\prime}=1}^{N_h} \sum_{j^{\prime}=1}^{N_j} \frac{P_{k^{\prime}|j^{\prime}}^{h^{\prime}}}{\mu_{j^{\prime}}},&\forall k, \label{eq3-34}\\
&\frac{\partial {\cal L}_1}{\partial \overline{\gamma}_{kj}}=0  \Longrightarrow \sum_{h^{\prime}=1}^{N_h} \frac{ \delta_{k|j}^{h^{\prime}}}{\mu_j \overline{\gamma}_{kj}} = \sum_{h^{\prime}=1}^{N_h} \frac{P_{k|j}^{h^{\prime}}}{\mu_j \overline{\gamma}_{kj}}, &\forall (j,k), \label{eq3-35}\\
&\frac{\partial {\cal L}_2}{\partial \overline{\mu}_{j}}=0 \Longrightarrow \sum_{h^{\prime}=1}^{N_h} \delta_{j}^{h^{\prime}} \ln p_4 = \sum_{h^{\prime}=1}^{N_h} P_j^{h^{\prime}} \ln p_4 , & \forall j, \label{eq3-36}\\
& p_4:=\sum \limits_{k^{\prime} \in {\cal K}_j} \left( \gamma_{k^{\prime}j}\exp{V_{k^\prime}}\right)^{1/\mu_j} &\label{eq3-37}
\end{align}
を得る．式\eqref{eq3-34}--\eqref{eq3-37}の詳細な導出は，付録 \ref{sec:3-A-2} に示す．

段階推定時の最適性条件\eqref{eq3-33}--\eqref{eq3-36} はその意味解釈が可能である．
まず，式\eqref{eq3-33}の左辺は，パラメータ推定に用いるデータで実際に購買された選択肢 $k$ の $m$ 番目の属性値（観測値）の合計を $\mu_j$ で除したものである．
もし，$j$ に関するデータが欠損している場合（選択肢 $k$ が選択されていることのみ分かる場合）は，そのすべての可能性の場合の数となる．
一方，式\eqref{eq3-33}の右辺は，推定される確率 $P_{k|j}^h$ で重み付けされた選択肢 $k$ の $m$ 番目の属性値（推定値）の合計を $\mu_j$ で除したものである．
${\sf{[Step~1]}}$ では，$\mu_j$ は推定対象ではなく単なるパラメータであるため，式\eqref{eq3-33} はこの両者が等しいことを意味している．
式\eqref{eq3-34}は，パラメータ推定に用いるデータで実際に選択された選択肢 $k$ の合計値（すなわち購買回数）を $\mu_j$ で除したものが
推定される確率 $P_{k|j}^h$ の合計値を $\mu_j$ で除したものと等しいことを意味している．
さらに，式\eqref{eq3-35} は，式\eqref{eq3-35}の $\mu_j$ を $\mu_j \gamma_{kj}$ に置き換え，$\sum_{j^{\prime}=1}^{N_j}$ を取り外したものである．
ただし，$\mu_j$ は ${\sf{[Step~1]}}$ において推定するパラメータではないため，条件\eqref{eq3-4} を満たす任意の定数と考えることができる．
式\eqref{eq3-36} は観測されたネスト選択数（観測値）にログサムをかけたものが，推定される確率 $P_{j}^h$ で重み付けされたログサムと等しいことを意味する．
ここで，賢明な読者は最大化問題\eqref{eq3-31}--\eqref{eq3-32}に制約条件\eqref{eq3-4}--\eqref{eq3-6}が含まれていないことに気付くだろう．

パラメータ制約条件\eqref{eq3-4}--\eqref{eq3-6}のうちいくつかは十分条件であり，式\eqref{eq3-31}--\eqref{eq3-32}内に含まれている．
まず，式\eqref{eq3-36}が成立するためには，
\begin{align}
\overline{\mu}_j \not = 0~~\forall ~j~ \Longrightarrow \eqref{eq2-34} \label{eq3-38}
\end{align}
となる．
同様に，式\eqref{eq3-35} が成立するためには，
\begin{align}
\overline{\gamma}_{kj} >0~~\forall~(j,k)~\Longleftrightarrow \eqref{eq2-35} \label{eq3-39}
\end{align}
となる．
最後に式\eqref{eq3-34}，\eqref{eq3-35}より，次式が導かれる：
\begin{align}
\sum_j & \overline{\gamma}_{kj}={\rm const.}, ~~\forall~k~\Longleftrightarrow \eqref{eq2-36}.\label{eq3-40}
\end{align}
ここでは便宜上 const.$=1$ とする．この点について Abbe et al. (2007) \cite{ABT07} は情報量を各ネストで揃えるためと述べているが，
対数尤度最大化問題では，明示的な制約条件として考慮する必要がないことが分かる．この点は同時推定時も同様である．
詳細は付録 \ref{sec:3-A-1} を参照されたい．
以上より，$\overline{\mu}_j > 1,~\overline{\mu}_j < 0$ 
という条件を除き，式\eqref{eq3-31}--\eqref{eq3-32}内にパラメータ制約条件\eqref{eq3-4}--\eqref{eq3-6}は含まれている．
条件\eqref{eq3-4}はあくまで効用最大化と整合的であるための条件であり，等価最適化問題を構成する上では無視できる．
この点は Train (2009) \cite{Tra09}，Kling and Herriges \cite{KH99}，Herriges and Kling \cite{HK96} に詳しく述べられている． 

\subsection{双対問題：等価エントロピー・モデル}
本節では，第 2 節で示された二段階の主問題に対し，双対問題として等価なエントロピー・モデルを示す．
同時推定時には双対問題をつくることができないが，段階推定の双対問題{{\sf{[Dual]}}について示そう．
なお，同時推定時の等価エントロピー・モデル構築における問題点は，付録 \ref{sec:3-A-1} を参照されたい．

段階推定による GNL モデルにおけるパラメータ推定の対数尤度最大化問題 {\sf{[Primal-}${\cal L}${\sf]}} は，次に示す段階的情報量最小化（エントロピー最大化）問題 {\sf{[Dual-}${\cal E}${\sf]}} と等価となる:\\
{\sf{[Dual-}${\cal E}${\sf]}}\vspace{-4.0mm}
\begin{align}
&{\sf{[Step~1]}}~{{\cal E}_1}:= \inf_{P_{k|j}^h \forall h,j,k} \sum_{h^{\prime}=1}^{N_h} \sum_{j^{\prime}=1}^{N_j} \sum_{k^{\prime}=1}^{N_k} \left[ P_{k^{\prime}|j^{\prime}}^{h^{\prime}} \ln P_{k^{\prime}|j^{\prime}}^{h^{\prime}} \right], \label{eq3-41}\\
&{\sf{[Step~2]}}~{{\cal E}_2}:= \inf_{P_j^h \forall h,j} \sum_{h^{\prime}=1}^{N_h} \sum_{j^{\prime}=1}^{N_j} \left[ P_{j^{\prime}}^{h^{\prime}} \ln P_{j^{\prime}}^{h^{\prime}}  \bigg|  {{\cal E}_1^{*}} \right], \label{eq3-42}\\
&\textnormal{s.t.} \eqref{eq3-33}\textnormal{--}\eqref{eq3-36}, \label{eq3-43}\\
& \sum_{k^{\prime}=1}^{N_k} P_{k^{\prime}|j}^{h} = 1,~~\forall j,h,\label{eq3-44}\\
& \sum_{j^{\prime}=1}^{N_j} P_{j^{\prime}}^h = 1,~~\forall h, \label{eq3-45}\\
&{\rm if}~P_{k|j}^h=0~{\rm or }~\gamma_{kj}=0 \Rightarrow P_{k|j}^h \ln P_{k|j}^h =0,~~\forall h,j,k. \label{eq3-46}
\end{align}
ここで，\eqref{eq3-44}，\eqref{eq3-45}はそれぞれ，$P_{k|j}^h$，$P_{j}^h$ が確率であるための条件である．
また，式\eqref{eq3-41}において，$\mu_j$ は任意のパラメータである．

具体的に，この情報量最小化問題 {\sf{[Dual-}${\cal E}${\sf]}} が満たす条件を明らかにしよう．
主問題 {\sf{[Primal-}${\cal L}${\sf]}} において，まず類似度パラメータ $\alpha_j$ について与件とし，$\alpha_m$，$\alpha_{0k}$，$\gamma_{kj}$ を推定し，その下で $\mu_j$ を推定するのと同様に，
まず $P_{k|j}^h$ を推定し，次に $P_{j}^h$ を推定する．

まず，入れ子の内側，式\eqref{eq3-41} に制約条件式\eqref{eq3-33}--\eqref{eq3-41}を考慮した Lagrangian $\hat \Lambda_1$ を用い，制約条件付き最小化問題を $P_{k|j}^h$ について解こう：\\
{\sf{[Step 1]}}
\begin{align}
&\hat \Lambda_1 := \sum_{h^{\prime}=1}^{N_h} \sum_{j^{\prime}=1}^{N_j} \sum_{k^{\prime}=1}^{N_k} P_{k^{\prime}|j^{\prime}}^{h^{\prime}} \ln {P_{k^{\prime}|j^{\prime}}^{h^{\prime}}} + \sum_{m^{\prime}=1}^{N_m} \lambda_{m^{\prime}} \left[ \sum_{h^{\prime}=1}^{N_h} \overline{X}_{km^{\prime}j} - \sum_{h^{\prime}=1}^{N_h} \sum_{j^{\prime}=1}^{N_j} \sum_{k^{\prime}=1}^{N_k} \frac{P_{k^{\prime}|j^{\prime}}^{h^{\prime}} X_{k^{\prime}m^{\prime}}}{\mu_{j^{\prime}}} \right] \notag\\
& \!+ \! \sum_{k^{\prime}=1}^{N_k} \!\left[ \lambda_{k^{\prime}} \!\left[ \overline{N}_{k^{\prime}} \! - \! \sum_{h^{\prime}=1}^{N_h} \sum_{j^{\prime}=1}^{N_j}  \frac{P_{k^{\prime}|j^{\prime}}^{h^{\prime}}}{\mu_{j^{\prime}}}  \right] \!\! + \lambda_{\hat{k}^{\prime}} \!\left[ \! \overline{N}_{k^{\prime}j}  \! - \! \sum_{h^{\prime}=1}^{N_h}  \frac{P_{k^{\prime}|j}^{h^{\prime}}}{\mu_j \overline{\gamma}_{k^{\prime}j}}  \right] \right]  \! \! + \! \sum_{h^{\prime}=1}^{N_h} \sum_{j^{\prime}=1}^{N_j} \! \lambda_{h^{\prime}j^{\prime}} \!\!\left[ 1- \sum_{k^{\prime}} P_{k^{\prime}|j^{\prime}}^{h^{\prime}} \right] . \label{eq3-47}
\end{align}
ここで，$\lambda_m$，$\lambda_{k}$，$\lambda_{\hat{k}}$，$\lambda_{hj}$ は，制約条件\eqref{eq3-33}，\eqref{eq3-34}，\eqref{eq3-35}，\eqref{eq3-44}に対応したラグランジュ乗数である．
また，
\begin{align}
\overline{X}_{kmj}:=\sum_{j^{\prime}=1}^{N_j} \sum_{k^{\prime}=1}^{N_k} \frac{\delta_{k^{\prime}|j^{\prime}}^h X_{k^{\prime}m}}{\mu_{j^{\prime}}} \label{eq3-48}
\end{align}
は，観測された $m$ 番目属性値をネスト $j$ の類似度パラメータの逆数 $1/\mu_j$ で重み付けした集計値，同様に，
\begin{align}
\overline{N}_k:=&\sum_{h^{\prime}=1}^{N_h} \sum_{j^{\prime}=1}^{N_j} \frac{\delta_{k|j^{\prime}}^{h^{\prime}}}{\mu_{j^{\prime}}},\label{eq3-49}\\
\overline{N}_{kj}:=&\sum_{h^{\prime}=1}^{N_h} \sum_{j^{\prime}=1}^{N_j} \frac{\delta_{k|j^{\prime}}^{h^{\prime}}}{\mu_{j^{\prime}} \overline{\gamma}_{kj^{\prime}}} \label{eq3-50}
\end{align}
は，それぞれサンプル数をネスト $j$ の類似度パラメータの逆数 $1/\mu_j$ もしくは それをさらに $1/\overline{\gamma}_{kj}$ で重み付けした集計値である．
$L_{1}$ の $P_{k|j}^h$ に関する最小化の一階条件より，
\begin{align}
\mu_j & \left( \ln P_{k|j}^h +1 \right) - \mu_j\lambda_{hj}  - \sum_{m^{\prime}=1}^{N_m} \lambda_{m^{\prime}} X_{km^{\prime}} - \lambda_{k} - \frac{\lambda_{\hat{k}}}{\overline{\gamma}_{kj}} = 0 \label{eq3-51}
\end{align}
を得る．式\eqref{eq3-51}を $P_{k|j}^h$ について解くと，
\begin{align}
P_{k|j}^h &= \exp \left( -1\right) \exp \left(\lambda_{hj} \right) \exp(\lambda_{\hat{k}}/(\overline{\gamma}_{kj}\mu_j) \exp \left( \frac{\lambda_k + \sum_{m^{\prime}=1}^{N_m} \lambda_{m^{\prime}} X_{km^{\prime}}}{\mu_j}\right) \label{eq3-52}
\end{align}
を得る．ここで，式\eqref{eq3-52}において前二つの $\exp$ 項は $k$ に依存しないのに対し，後二つの $\exp$ 項は $k$ に依存していることに注意されたい．これより，式\eqref{eq3-52}を式\eqref{eq3-40}に代入し，整理すると，
\begin{align}
&\exp \left( -1 \right)\exp \left( \lambda_{hj} \right) = \frac{1}{ \sum \limits_{k^{\prime}=1}^{N_k} \left(\exp(\lambda_{\hat{k}^{\prime}}/\overline{\gamma}_{k^{\prime}j}) \exp \left( \lambda_{k^{\prime}}+\sum_{m^{\prime}=1}^{N_m} \lambda_{m^{\prime}} X_{km^{\prime}}\right)\right)^{1/{\mu_j}}} \label{eq3-53}
\end{align}
を得る．これをさらに式\eqref{eq3-52}に代入すると，
\begin{align}
&P_{k|j}^h =\frac{\left(\exp (\lambda_{\hat{k}} /\overline{\gamma}_{kj}) \exp \left( \lambda_{k} + \sum_{m^{\prime}=1}^{N_m} \lambda_{m^{\prime}} X_{km^{\prime}} \right)\right)^{1/{\mu_j}}}{ \sum \limits_{k^{\prime}=1}^{N_k} \left(\exp(\lambda_{\hat{k}^{\prime}}/\overline{\gamma}_{k^{\prime}j})
\exp \left( \lambda_{k^{\prime}} + \sum_{m^{\prime}=1}^{N_m} \lambda_{m^{\prime}} X_{k^{\prime}m^{\prime}} \right)\right)^{1/{\mu_j}}} \label{eq3-54}
\end{align}
となる．ここで，条件\eqref{eq3-46}を考えると，
\begin{align}
&P_{k|j}^h =\frac{\left(\exp (\lambda_{\hat{k}/}\overline{\gamma}_{kj}) \exp \left( \lambda_{k} + \sum_{m=1}^{N_m} \lambda_m X_{km}\right)\right)^{1/{\mu_j}}}{ \sum \limits_{k^{\prime} \in {\cal K}_j} \left(\exp(\lambda_{\hat{k}^{\prime}}/\overline{\gamma}_{k^{\prime}j}) \exp \left( \lambda_{k^{\prime}} + \sum_{m=1}^{N_m} \lambda_m X_{k^{\prime}m}\right)\right)^{1/{\mu_j}}} \label{eq3-55}
\end{align}
となる．
これは，式\eqref{eq2-50}のネスト $j$ を与件とした時の選択肢 $k$ の選択確率式に他ならない．

$\lambda_k$，$\lambda_m$ がそれぞれ，$\overline{\alpha}_{0k}$，$\overline{\alpha}_m$ に対応するのは容易に分かるが，$\lambda_{\hat{k}}$ と $\overline{\gamma}_{kj}$ は対応するだろうか．
ここで，$\exp(\lambda_{\hat{k}}/\overline{\gamma}_{kj})$ は $\lambda_{\hat{k}}$ に関して単調増加もしくは減少関数であるため，$\gamma_{kj}$ と一対一対応する．
ただし，$\exp(\lambda_{\hat{k}}/\overline{\gamma}_{kj})>0$ であり，ネスト$j$ に選択肢 $k$ が所属しない場合（$\gamma_{kj}=0$）を含め，
\begin{align}
\exp(\lambda_{\hat{k}}/\overline{\gamma}_{kj} ) \Longrightarrow  \gamma_{kj} \geq 0 \Longleftrightarrow  \eqref{eq2-35} \label{eq3-56}
\end{align}
が導かれる．

{\sf{[Step 1]}}と同様に，{\sf{[Step 2]}}のラグラジアン $\hat \Lambda_2$ も\\
{\sf{[Step 2]}}
\begin{align}
\hat \Lambda_2 &:=  \sum_{h^{\prime}=1}^{N_h} \sum_{j^{\prime}=1}^{N_j} \left[ P_{j^{\prime}}^{h^{\prime}} \ln P_{j^{\prime}}^{h^{\prime}} \right] + \sum_{j^{\prime}=1}^{N_j} \lambda_{j^{\prime}} \left[ \Psi_{j^{\prime}} - \sum_{h^{\prime}=1}^{N_h} P_{j^{\prime}}^{h^{\prime}} \ln p_4 \right] + \sum_{h=1}^{N_h} \lambda_h \left[ 1- \sum_{j=1}^{N_j} P_j^h \right] \label{eq3-57}
\end{align}
としよう．ここで，$\lambda_j$，$\lambda_h$ はそれぞれ制約条件\eqref{eq3-36}, \eqref{eq3-45} に対応したラグランジュ乗数である．また，$\Psi_j := \sum_{h^{\prime}=1}^{N_h} \delta_j^{h^{\prime}} \ln p_4$ は観測されたログサム変数の集計値である．
$P_j^h$ についても，一階条件より，
\begin{align}
&(\ln P_j^h +1) - \lambda_h - \lambda_j  \ln \left( \sum_{k^{\prime} \in {\cal K}_j} ( \gamma_{k^{\prime}j} \exp V_{k^{\prime}} )^{1/\mu_j} \right) = 0 \label{eq3-58}
\end{align}
となる．式\eqref{eq3-58}を $P_{j}^h$ について解くと，
\begin{align}
P_j^h = \exp (\lambda_h ) \exp ( -1) \left( \sum_{k^{\prime} \in {\cal K}_j} ( \gamma_{k^{\prime}j} \exp V_{k^{\prime}} )^{1/\mu_j} \right)^{\lambda_j} \label{eq3-59}
\end{align}
を得る．これを\eqref{eq3-41}に代入し，整理すると，
\begin{align}
\exp (\lambda_h ) \exp ( -1) = \frac{1}{\sum \limits_{j^{\prime}=1}^{N_j} \left( \sum \limits_{k^{\prime} \in {\cal K}_{j^{\prime}}} ( \gamma_{k^{\prime}j} \exp V_{k^{\prime}} )^{1/\mu_j} \right)^{\lambda_j}}\label{eq3-60}
\end{align}
を得る．これをさらに式\eqref{eq3-41}に代入し，整理すると，
\begin{align}
P_j^h=\frac{ \left( \sum \limits_{k^{\prime} \in {\cal K}_j} ( \gamma_{k^{\prime}j} \exp (\sum_{m^{\prime}=1}^{N_m} \alpha_{m^{\prime}} X_{m^{\prime}k^{\prime}} +\alpha_{0k^{\prime}} ))^{1/\mu_j} \right)^{\lambda_j} }
{ \sum \limits_{j^{\prime}=1}^{N_j} \left( \sum \limits_{k^{\prime} \in {\cal K}_{j^{\prime}}} (\gamma_{k^{\prime}j^{\prime}} \exp (\sum_{m^{\prime}=1}^{N_m} \alpha_{m^{\prime}} X_{m^{\prime}k^{\prime}} +\alpha_{0k^{\prime}}) )^{1/\mu_{j^{\prime}}} \right)^{\lambda_{j^{\prime}} }} \label{eq3-61}
\end{align}
を得る．
ただし，$\alpha_{m}$，$\alpha_{0k}$は，{\sf{[Step 1]}}で推定されたパラメータ（ラグランジュ乗数）であり，
$\mu_j$ は $0$ ではなく，ネスト$j$ により異なる任意の数である．従って，$\lambda_j\Leftrightarrow \mu_j$ と交換可能である．
ここでさらに，$\lambda_j\Leftrightarrow \overline{\mu}_j$ とすると，式\eqref{eq3-61}は，式\eqref{eq2-49}のネストの選択確率式に他ならない．

最後に，$P_j^h, P_{k|j}^h$ 間の ``マルコフ性'' より次式を得る：
\begin{align}
P_k^h = \sum_{j^{\prime}=1}^{N_j} P_{j^{\prime} P_{k|j^{\prime}}^h.\label{eq3-62}
\end{align}
情報量最小化問題 ${\cal E}$ における 式\eqref{eq3-62}，\eqref{eq3-61}，\eqref{eq3-55} がそれぞれ，最尤推定問題 ${\cal L}$ における GNL モデルの選択確率式の式\eqref{eq2-48}--\eqref{eq2-50}に対応する．
%****************************************************************************************************************************************
\subsection{非集計レベルの等価性の証明}
本章では，GNL モデルが，パラメータの最尤推定，ラグランジュ乗数による情報量最小化，それぞれ同じに同定されることを示す．
また，Anas (1983) \cite{Ana83} と同様に各パラメータとラグランジュ乗数との関係を示す．

\begin{proposition}[モデルの等価性]
$\overline{{\bm \theta}}_1^{*}$，$\overline{{\bm \theta}}_2^{*}$ をそれぞれ式\eqref{eq3-31}，\eqref{eq3-32}により二段階で最尤推定された，パラメータ・ベクトル $\overline{{\bm \theta}}_1$，$\overline{{\bm \theta}}_2$ としよう．
同様に，$\overline{{\bm \lambda}}_1^{*}$，$\overline{{\bm \lambda}}_2^{*}$ をそれぞれ式\eqref{eq3-41}，\eqref{eq3-42}に \eqref{eq3-43}--\eqref{eq3-46}の制約条件を考慮して二段階で情報量最小化された，ラグランジュ乗数ベクトル $\overline{{\bm \lambda}}_1$，$\overline{{\bm \lambda}}_2$ としよう．
同じデータ（${\bm \delta}_{k|j}^h$，${\bm \delta}_{j}^h$，${\bm X}_{m}^h$）が与えられたならば，この二つの問題（{\sf{[Primal-}${\cal L}${\sf]}}，{\sf{[Dual-}${\cal E}${\sf]}}）は，それぞれ同じ解（$\overline{{\bm \theta}}_1^{*}=\overline{{\bm \lambda}}_1^{*}$，$\overline{{\bm \theta}}_2^{*}=\overline{{\bm \lambda}}_2^{*}$）を持つ．
\end{proposition}
\begin{proof}
最尤推定問題 ${\cal L}$ と，情報量最小化問題 ${\cal E}$ は互いに交換可能な形で {\rm GNL} モデルの選択確率：式\eqref{eq2-48}--\eqref{eq2-50}もしくは，式\eqref{eq3-62}，\eqref{eq3-61}，\eqref{eq3-55}を得る．
これらの二つの式の集合は恒等であり，$P_{k|j}^h(\overline{{\bm \theta}}_1)$，$P_{j}^h(\overline{{\bm \theta}}_2)$ は，それぞれ $P_{k|j}^h(\overline{{\bm \lambda}}_1)$，$P_{j}^h(\overline{{\bm \lambda}}_2)$ とそれぞれ同じ関数であるため，$\overline{{\bm \theta}}_1^{*}=\overline{{\bm \lambda}}_1^{*}$，$\overline{{\bm \theta}}_2^{*}=\overline{{\bm \lambda}}_2^{*}$ を得る．\QED
\end{proof}
\begin{lemma}
$m$ 番目の属性の限界効用 $\alpha_m$ は，観測される選択肢の選択結果及び $m$ 番目の説明変数値を $1/\mu_j$ で重み付けした集計値 $\overline{X}_{kmj}$ の変化によるレベル $1$ のエントロピーの限界変化に等しい．
\end{lemma}
\begin{proof}
$\alpha_{m}^{*}= \partial U_k^h / \partial X_{mk}^h~\forall k$ かつ $\lambda_{m}^{*}= \partial {{\cal E}_1} / \partial \overline{X}_{m}$ であり，$\alpha_{m}^{*}=\lambda_{m}^{*}$ から，$\partial U_{k}^h/\partial X_{km}^h= \partial {{\cal E}_1}/\partial \overline{X}_{kmj}~\forall k$ を得る．\QED
\end{proof}
\begin{lemma}
固有選好度 $\alpha_{0k}$ は，観測される選択肢の $k$ の選択結果を $1/\mu_j$ で重み付けした集計値 $\overline{N}_k$ の変化によるレベル $1$ のエントロピーの限界変化に等しい．
\end{lemma}
\begin{proof}
$\lambda_{k}^{*}= \partial {{\cal E}_1}/\partial \overline{N}_k$ であり，$\alpha_{0k}^{*}=\lambda_{k}^{*}$ から，$\alpha_{0k}^{*} = \partial {L}_1/\partial \overline{N}_k~\forall k$ となる．\QED
\end{proof}
\begin{lemma}
アロケーション・パラメータ $\gamma_{kj}$ は，観測される選択肢の $k$ の選択結果を $\frac{1}{\mu_j \gamma_{kj}}$ で重み付けした集計値 $\overline{N}_{kj}$ の変化によるレベル $1$ のエントロピーの限界変化に等しい．
\end{lemma}
\begin{proof}
$\lambda_{\hat{k}}^{*}= {{\cal E}_1}/\partial \overline{N}_{kj}$ であり，$\gamma_{kj}^{*}=\lambda_{\hat{k}}^{*}$ から，$\gamma_{kj}^{*} = \partial {{\cal E}_1}/\partial \overline{N}_{kj}~\forall (k,j)$ となる．\QED
\end{proof}
\begin{lemma}
類似度パラメータ $\mu_j$ は，ログサム $p_4$ の変化によるレベル $2$ のエントロピーの限界変化に等しい．
\end{lemma}
\begin{proof}
$\lambda_{j}^{*}= \partial {{\cal E}_2}/\partial p_4$ であり，$\mu_{j}^{*}=\lambda_{j}^{*}$ から，$\mu_{j}^{*} = \partial {{\cal E}_2}/\partial p_4~\forall j$ となる．\QED
\end{proof}
%****************************************************************************************************************************************
%\subsection{データの集計化を行なった場合との対応}
%前章までで，GNL が非集計的に対数尤度最大化，情報量最小化でパラメータ推定可能であることを示した．
%この「非集計的」ということは，各消費者（購買機会） が何を購入したか，つまり ${\bm \delta}$ が既知であることを意味している．
%しかし，実際のマーケティングのデータは，何が何個売れたかというマーケット・シェアのみしか分からない場合が多い．
%価格についても平均価格しかわからない場合が多く，実際の購買価格やライバル商品のその時点，その顧客にとっての価格は不明な場合も多い．
%また，デモグラフィック変数が分かったとしても，お客様カード等の登録時の情報のみで，それが信頼するに足る情報でない場合もある．
%さらに，現実的には非集計レベルの等価エントロピー・モデルを直接解くには，制御変数 $P_{k|j}^h$，$P_{j}^h$ が多すぎて，計算に多大な時間とメモリーを要するという問題点もある．
%
%Anas が示した MNL の場合と同様に GNL においても，選択結果が集計処理されている場合でも，段階推定における最尤推定問題と情報量最小化問題の等価性そのものは保たれる．
%ただし，効用関数，選択確率式は次のように書き換えられる:
%\begin{align}
%V_k^A &=  \sum_m \alpha_{m}^A \overline{X}_{mk} + \alpha_{0k}^A,\\
%P_k^A &=  \sum_j P_j^A P_{k|j}^A,\label{eq3-51}\\
%P_j^A &=  \frac{\left( \sum \limits_{k^{\prime} \in N_j} \left(\gamma_{k^{\prime}j}^A \exp{V_{k^\prime}^A}\right)^{1/\mu_j^A}\right)^{\mu_j}}
%{\sum \limits_j {\left( \sum \limits_{k^{\prime} \in N_j} \left(\gamma_{k^{\prime}j}^A \exp{V_{k^\prime}^A} \right)^{1/\mu_j^A}\right)^{\mu_j}}},\label{eq3-52}\\
%P_{k|j}^A  &=  \frac{\left( \gamma_{kj}^A \exp{V_k}^A \right)^{1/\mu_j}}
%{\sum \limits_{k^{\prime} \in N_j} \left( \gamma_{k^{\prime}j}^A \exp{V_{k^\prime}^A} \right)^{1/\mu_j}}.\label{eq3-53}
%\end{align}
%ここで，上付きの $A$ は集計した場合の選択確率やパラメータを表わし，$\overline{X}_{mk}$ は，$X_{mk}$ の平均値であり，
%$P_k^A$，$P_j^A$，$P_{k|j}^A$ は，単なる選択確率ではなく，期待選択確率もしくは，割合である．
%また，制約条件 \eqref{eq3-4}--\eqref{eq3-6} はそのままとなる．
%問題 ${\cal L}$は，次のようになる：
%\begin{align}
%&{\cal L} \Longrightarrow {\cal L}^{A}\notag\\
%&{\sf{[Step~1]}}{\cal L}_1^{A}:= \sup_{\substack{ \overline{\alpha}_m^A \forall m \\ \overline{\alpha}_{0k}^A \forall k \\ \overline{\gamma}_{kj}^A \forall (k,j)}}  \sum_j \sum_k N_{k|j} \ln P_{k|j}^A ( \overline{\alpha}_m^A, \overline{\alpha}_{0k}^A,\overline{\gamma}_{kj}^A ), \notag\\
%&{\sf{[Step~2]}} {\cal L}_2^{A}:= \sup_{\overline{\mu}_j^A \forall j} \left\{ \sum_j N_{j} \ln P_{j} ( \overline{\mu}_j^A ) \Bigg| {\cal L}_1^{A*} \right\}. \notag
%\end{align}
%ここで $H_{k|j}$，$H_j$はそれぞれネスト $j$ を選択した上で選択肢 $k$ を選択した人数（購買機会数），ネスト $j$ を選択した人数（購買機会数）である．
%同様に問題 ${\cal E}$は，\\
%${\cal E} \Longrightarrow  {\cal E}^{A}$ \vspace{-4.0mm}
%\begin{align}
%&{\sf{[Step~1]}}~{\cal E}_1^{A}:= \inf_{P_{k|j}} \sum_j \left\{ \sum_k P_{k|j} \ln {P_{k|j}} \right\}, \label{eq3-56}\\
%&{\sf{[Step~2]}}~{\cal E}_2^{A}:= \inf_{P_j} \sum_j \left[ P_{j} \ln P_{j}  \bigg|  {{\cal E}_1^{A*}} \right], \label{eq3-57}\\
%& \sum_{k} P_{k|j} = H_{k|j}/H_j,~~\forall j,k,\label{eq3-58}\\
%& \sum_k P_{j} = H_j/H,~~\forall j \label{eq3-59}
%\end{align}
%となる．ここで，$H$ は総サンプル数である．
%ただし，
%\begin{align}
%\overline{{\bm \theta}}_1^{*} &\not = \overline{{\bm \theta}}_1^{A*},\\
%\overline{{\bm \theta}}_2^{*} &\not = \overline{{\bm \theta}}_2^{A*}
%\end{align}
%であることに注意されたい．ここで，$\overline{{\bm \theta}}_1^{A*}$，$\overline{{\bm \theta}}_2^{A*}$ はそれぞれ集計された場合の二段階で最尤推定されたパラメータ・ベクトルである．
%****************************************************************************************************************************************
\subsection{GNL モデルにおけるパラメータ推定への示唆}
本節では，3 節で示されたGNL モデルにおけるパラメータ最尤推定問題の段階におけるパラメータ割当，双対性から，
GNL モデルにおけるパラメータ推定問題へ二つの示唆を与える．
まず，前者について，提案されている Vovsha (1997)\cite{Vov97} のアルゴリズムにおけるパラメータ割当の問題点を指摘し，改良を行なう．
次に，後者について，双対性を利用した前者から更に発展させたアルゴリズムの提案を行なう．

Vovsha (1997)\cite{Vov97} は GNL モデルの特殊形である CNL ($\mu_j:=\mu~\forall j$) を提案するにあたり，ヒューリスティックと断り書きをした上で，パラメータ推定アルゴリズムを提案している．
ただし，Vovsha では，固有選好度 $\alpha_{0k}$ を省略しており，このことがアルゴリズムの特殊性へと繋がっている．
$\alpha_{0k}$ は選択肢 $k$ に依存するため，ネスト $j$ を与件とした場合，アロケーション・パラメータ $\gamma_{kj}$ との関係性が強い．
Vovsha のアルゴリズムはこの点を踏まえ，$\gamma_{kj}$ を一旦設定し，その後 $\alpha_{0k}$ を推定し，それを $\gamma_{kj}$ に変換している．
しかし，この方法は， $\alpha_{0k}$ と $\gamma_{kj}$ 両方がある場合には適用することが出来ない． 

図\ref{fig3-1} に Vovsha (1997)\cite{Vov97} の提案したアルゴリズムを示す．
ただし，図\ref{fig3-1} のアルゴリズムは，CNL モデルのそれから GNL モデルのそれへ $\mu\Rightarrow \mu_j$ と変化させている．
\begin{figure}[t!]
  \centering
  \psbox[width=0.40 \linewidth]{clip3-1}
\caption{Vovsha (1997)\cite{Vov97} の提案アルゴリズム}
\label{fig3-1}
\end{figure}
このアルゴリズムは以下のようなものである．まず，Step 1 で，$\gamma_{kj}^0$，$\mu_j^0$ と初期値を設定する．次に，Step 2 として，$\gamma_{kj}^l$ のみから算入確率 $P_{k|j}^{\prime l}$ というものを計算する．
この算入確率から，欠損しているネスト $j$ に関する情報を補うために，Step 3 でダミーの選択情報 $\delta_{k|j}^{l,h^{\prime}}=\delta_k^h$ を生成する．
このとき，サンプル数 $H_{k|j}^{{\prime}l}$ を算入確率 $P_{k|j}^{\prime l}$ を用い，$100 \times P_{k|j}^l$ に一番近い整数とする．
そして，Step 4 で通常の同時最尤推定法 [FIML--GNL] で $\alpha_m^l$，$\mu_j^l$ 及び $\alpha_{kj0}^l$ を推定する．
Step.5 では，推定された $\alpha_{kj0}^l$ から $\gamma_{kj}^l$ への変換：
\begin{align}
\gamma_{kj}^l=\exp \left(\alpha_{kj0}^l-\max_{j^{\prime} \in {\cal T}} \alpha_{kj^{\prime}0}^l \right) \label{eq3-63}
\end{align}
を行ない，Step. 6 では，条件\eqref{eq2-36}で $\gamma_{kj}^l$ を正規化する．この正規化された $\gamma_{kj}^l$ をStep 2に代入し，Step 2--6 を収束するまで繰り返す．
しかし，この方法では固有選好度 $\alpha_{0k}$ と アロケーション・パラメータ $\gamma_{kj}$ 両方がある，一般的な GNL には適用することが出来ない．

本章で提案する手法は，図\ref{fig3-2} に示すものである．
Vovsha \cite{Vov97} のアルゴリズムとは，大きく二つの点が異なる．
一つ目は，同時推定時の初期値の扱いが異なる．
提案手法では，まず 3,4 章で確かめられた段階推定時のパラメータの分担をもとに，各パラメータを[$S_k$--GNL] 及び[$S_j$--GNL]で段階推定する．
ここで，$S_k$，$S_j$ は選択肢段階，ネスト段階の段階最尤推定を意味する．
GNL モデルはその性質から，Marzano and Papola (2008) \cite{MP08} により，一般的に対数尤度最大化時に局所最適に陥りやすいことが知られている．
これをなるべく回避するため，段階推定されたパラメータを初期値として一括推定を行なう．
初期値として段階推定を行なうのは，段階推定では同時推定時には保証されない凸性が（各段階内においては）保証されており，Newton 法などの比較的収束が早いアルゴリズムを用いても解が発散する恐れが少ないためである．
段階推定されたパラメータを同時推定時の初期値として用いることは，NL モデルにおいては，構造推定上問題があることが Hensher (1986) \cite{Hen86} により指摘されている．
しかし，GNL モデルでは，複数のネストへの帰属を可能とし，構造推定上の制約がないため，上記の問題点は存在しない．
二つ目は，制約条件 \eqref{eq2-36} をパラメータ推定時にキャリブレーション内で明示的に課さない点にある．
これは，条件\eqref{eq3-34}，\eqref{eq3-35}より，対数尤度最大化においては，アロケーション・パラメータの制約条件 \eqref{eq2-36} を明示的に考慮する必要がないためである．
従って，キャリブレーションを終了してから一括して正規化する．これは，段階推定時，同時推定時両方ともに適用できる．
実際に推定する際には，固有選好度や類似度パラメータと同様に，$0$ になりそうにない特定の $\gamma_{kj}$ を $1$ なり何らかの非負の数に固定すればよい．
\begin{figure}[t!]
  \centering
  \psbox[width=0.56 \linewidth]{clip3-2}
\caption{提案アルゴリズム}
\label{fig3-2}
\end{figure}
{\tabcolsep = 1.35mm
\begin{table*}[!t]
\begin{center}
\caption{段階推定時 (Step)，同時推定時 (Sim.) のパラメータ}\label{tb3-1}
\begin{tabular}
{crrcrrcrrcrrcrr}
\toprule
&Step&Sim.&&Step&Sim.&&Step&Sim.&&Step&Sim.&&Step&Sim.
\\\noalign{\smallskip} \hline\hline \noalign{\smallskip} 
$\alpha_1$ & $-0.021$& $-0.014$ & $\gamma_{11}$ & $0.271$ & $0.272$ & $\gamma_{31}$ & $0.189$ & $0.090$ & $\gamma_{52}$ & $0.095$& $0.103$ & $\gamma_{72}$ & $0.138$& $0.090$\\
$\alpha_2$ & $0.623$&  $0.485$ & $\gamma_{13}$ & $0.624$ & $0.271$ & $\gamma_{33}$ & $0.426$ & $0.543$ & $\gamma_{53}$ & $0.805$& $0.680$ & $\gamma_{73}$ & $0.570$& $0.910$\\
$\alpha_3$ & $0.004$&  $0.002$ & $\gamma_{15}$ & $0.104$ & $0.456$ & $\gamma_{36}$ & $0.385$ & $0.367$ & $\gamma_{55}$ & $0.100$& $0.217$ & $\gamma_{76}$ & $0.292$& $0.000$\\
$\alpha_4$ & $-0.384$& $-0.370$ & $\gamma_{21}$ & $0.576$ & $0.608$ & $\gamma_{41}$ & $0.382$ & $0.239$ & $\gamma_{62}$ & $0.391$& $1.000$ & $\gamma_{82}$ & $0.195$& $0.000$\\
$\alpha_5$ & $1.258$& $0.731$ & $\gamma_{24}$ & $0.129$ & $0.222$ & $\gamma_{44}$ & $0.077$ & $0.170$ & $\gamma_{64}$ & $0.227$& $0.000$ & $\gamma_{84}$ & $0.093$& $0.218$\\
$\mu_1$ & $0.503$& $0.185$ & $\gamma_{25}$ & $0.295$ & $0.170$ & $\gamma_{46}$ & $0.541$ & $0.591$ & $\gamma_{65}$ & $0.382$& $0.000$ & $\gamma_{86}$ & $0.713$& $0.782$\\
$\mu_2$ & Fix$\ast$ & Fix$\ast$ & $\mu_{3}$ & $0.225$ & $0.342$ & $\mu_{4}$ & $0.626$ & $0.573$ & $\mu_{5}$ & $1.000$& $0.462$ & $\mu_{6}$ & $0.146$& $0.397$
\\\bottomrule
\multicolumn{15}{l}{$\ast 1.0000$ に固定．}
\end{tabular}
\end{center}
\end{table*}}

実際に Takahashi (2011) \cite{Tak11} の問題に適用し，提案されたパラメータ手法を用い，同じパラメータが推定できるかを試す．
その結果， 表\ref{tb3-1} に示すように Takahashi (2011) \cite{Tak11} で複数回の初期値からスタートしたものから最良のパラメータと同様のパラメータを段階推定したパラメータを初期値として得ることが出来た．
ただし，類似度パラメータ，アロケーション・パラメータの一部に値の乖離がみられる．

また，3, 4 節で証明された双対性を利用したアルゴリズムをパラメータ推定に用いることも考えられる．
具体的には，主双対内点法\cite{Meh92,UUV04}が挙げられる．
図\ref{fig3-2}におけるStep. 4,~5 においてこの主双対内点法を適用することにより，より効率的に局所最適に陥っているか確かめることができる．
ただし非集計の場合，双対問題の推定パラメータ数が膨大になる（$P_{k|j}^h$，$P_j^h$ $\forall~j,k,h$）ため，ある程度集計した方が，主双対内点法を用いる際には現実的である．
%****************************************************************************************************************************************
\section{3 章のまとめ}
本研究では効用最大化と整合的である GNL モデルについて，集計レベル，非集計レベルにおいてエントロピー・モデルとの等価性を示した．
これにより，GNL もエントロピー・モデルとして解釈可能であることを示し，その情報理論的な側面からの意味を示すことができた．

まず，集計レベルでは，GNL モデルは $2$ つのエントロピー制約を持つ数理計画問題と等価であることが示された．
これらの結果により， GNL と等価なエントロピー・モデル（式 \eqref{eq3-8}）に内包される全てのエントロピー・モデルは，効用最大化と整合的な行動を記述している
こととなる．すなわち，そのようなエントロピー・モデルの下では，消費者は（ランダム）効用最大化するように行動している．
これは，エントロピーというある種の系の集計量と，効用最大化という非集計的な個々の行動（の集計量）がある特別な場合には矛盾しないということを意味している．
効用最大化という消費者行動の記述は，一般的には将来的にも担保されるものとマーケティング・サイエンスでは考えられ，これに基づき需要予測等の各種の予測がされることとなる．
つまり，ある種のエントロピー・モデルも同様に需要予測において行動記述を担保として，将来も効用最大化行動を行っているものとして予測が可能であることを意味する．

次に，非集計レベルでは，GNL モデルのパラメータ推定における段階推定対数尤度最大化問題の一段階目，二段階目それぞれが，段階的情報量最小化問題のそれぞれに対応することを示した．
これにより，GNL モデルが非集計的にエントロピー・モデルとして解釈可能であることを示し，その情報理論的な側面の意味を示すことができた．
また，パラメータ推定を行なう上で，アロケーション・パラメータに関する制約条件は明示的に考慮する必要がなく，制約なしの対数尤度最大化問題にその条件が含まれていることを示した．
これらの事実を基に，Vovsha で提案されたパラメータ推定方法の改良を提案した．
ここでは，Vovsha の特徴である固有選好度がある場合でも適用可能かつ安定的なパラメータ推定方法を提案した．
これは，一度段階推定したパラメータを初期値として同時推定することにより得られる．
また，アロケーション・パラメータの正規化はその各段階で行なう必要がないことを等価性の証明より導いた．
最後に，対数尤度最大化問題と情報量最小化問題の双対性に着目した主双対内点法を利用したアルゴリズムの提案をした．

今後の課題としては，情報理論的にあいまいさを考慮している Fuzzy Logit Model\cite{Hen00} や，その拡張モデルについても
エントロピー・モデルとの等価性を示すことが挙げられる．
式 \eqref{eq3-8}にファジー・エントロピー項や更なるエントロピー項を追加しても，GNL モデルの選択確率式と同様に，ファジー項がついた MNL，Three-level NL 等のモデルの選択確率式が結果として得られることは，
想像するに難くない．
また，提案されたアルゴリズムの実装，適用が挙げられる．
ただし，主双対内点法を利用したアルゴリズムについては，計算速度の向上を狙ったものではないことに注意する必要がある．

\def\thesection{\thechapter.\Alph{section}}
\setcounter{section}{0} 
\section{付録}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{GNL における同時推定時の等価エントロピー・モデル構築の問題点}\label{sec:3-A-1}
GNL における最尤パラメータ推定では，本研究で採用した段階推定と，同時推定がある．
同時推定では，段階推定の煩わしさや段階推定における一段階目の t 値の過大推定の問題点がなくなるという利点がある．

同時推定時のパラメータ推定問題 {\sf{[Primal-}${\cal L^{\prime}}${\sf]}}は次のように表わすことができる：\\
 {\sf{[Primal-}${\cal L^{\prime}}${\sf]}}
\begin{align}
{ \cal{L}^{\prime}}  :=  \sup \limits_{\substack{ \overline{\alpha}_m \forall m \\ \overline{\alpha}_{0k} \forall k \\ \overline{\gamma}_{kj} \forall (k,j) \\ \overline{\mu}_j \forall j}} \sum_{h^{\prime}=1}^{N_h} \sum_{j^{\prime}=1}^{N_j} \sum_{k^{\prime} \in {\cal K}_{j^{\prime}}}
\delta_{j^{\prime},k^{\prime}}^{h^{\prime}} \left( \ln P_{j^{\prime}}^{h^{\prime}} + \ln P_{k^{\prime}|j^{\prime}}^{h^{\prime}} \right). \label{eq3-78}
\end{align}
ここで，$\delta_{j,k}^h$ は，消費者 $h$ がネスト $j$ により選択肢 $k$ を選択した場合 $1$，それ以外は $0$ を示す変数である．
式\eqref{eq3-78}の一階条件は，例えば $\overline{\mu}_j$ の場合，
\begin{align}
&\frac{\partial {\cal L^{\prime}}}{\partial \overline{\mu}_j} =  \sum \limits_{h^{\prime}=1}^{N_h} (1-P_j^{h^{\prime}}) \left[ \ln p_4 (\overline{\mu}_j ) - \sum_{k^{\prime} \in {\cal K}_j} P_{k^{\prime}|j}^{h^{\prime}} \ln \left(\gamma_{k^{\prime}j^{\prime}} \exp V_{k^{\prime}}^h \right)^{1/\overline{\mu}_j} \right] \notag\\
&+  \sum \limits_{h^{\prime}=1}^{N_h} \frac{1}{\overline{\mu}_j}  \left[ \! \ln p_3 (\overline{\mu}_j)  -  \sum_{k^{\prime} \in {\cal K}_j}  P_{k^{\prime}|j}^h  \ln  \left(\gamma_{k^{\prime}j} \! \exp{V_{k^\prime}}^h \right)^{1/\overline{\mu}_j}  \right],\forall j \label{eq3-79}
\end{align}
となる．しかし式 \eqref{eq3-79} は，明らかに $\overline{\mu}_j$ に関して非線形である．従って，同時推定の場合，陽には，段階推定と同様な対数尤度最大化問題と等価なエントロピー・モデルを構築することは出来ない．

ただし，同時推定でも $\sum_{j^{\prime}=1}^{N_j} \gamma_{kj^{\prime}} =1~({\rm Const.}）~\forall k$ という条件は対数尤度最大化問題に内包されている．
$\overline{\alpha}_{0k}$ に関する対数尤度関数 ${ \cal{L^{\prime}}}$ の偏微分は，
\begin{align}
\frac{\partial { \cal{L^{\prime}}}}{\partial \overline{\alpha}_{0k}}=& \sum \limits_{h^{\prime}=1}^{N_h} \sum \limits_{j^{\prime}=1}^{N_j} \left[ P_{k|j^{\prime}}^{h^{\prime}} \left( \delta_{j^{\prime},k}^{h^{\prime}} - P_{j^{\prime}}^{h^{\prime}} \right)  + \frac{1}{\overline{\mu}_{j^{\prime}}}\left( \delta_{j^{\prime},k}^h- P_{k|j^{\prime}}^h \right) \right],~\forall k \label{eq3-80}
\end{align}
となる．同様に，$\overline{\gamma}_{kj}$ に関する対数尤度関数 ${ \cal{L^{\prime}}}$ の偏微分は，
\begin{align}
\frac{\partial { \cal{L^{\prime}}}}{\partial \overline{\gamma}_{kj}} =& \frac{1}{\overline{\gamma}_{kj}}  \sum \limits_{h^{\prime}=1}^{N_h} \left[  P_{k|j}^{h^{\prime}} \left( \delta_{j,k}^{h^{\prime}}  -  P_j^{h^{\prime}} \right) + \frac{1}{\overline{\mu}_j} \left( \delta_{j,k}^{h^{\prime}} - P_{k|j}^{h^{\prime}} \right) \right] ,~\forall (k,j) \label{eq3-81}
\end{align}
となる．式 \eqref{eq3-80}，\eqref{eq3-81} より，$\sum_{j^{\prime}=1}^{N_j} \gamma_{kj^{\prime}} =1({\rm Const.}）~\forall k$ が導かれる．つまり，同時推定においても条件\eqref{eq2-34} を明示的に制約条件として考慮する必要はない．
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{式\eqref{eq3-33}--\eqref{eq3-36}の導出}\label{sec:3-A-2}
ここでは，本文中で省略した式\eqref{eq3-33}--\eqref{eq3-36}の導出について，段階を追って詳細を示す．
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{$\overline{\alpha}_{m}$ に関する ${\cal L}_1$ の偏微分}
まず，$p_3, p_4$ 各項の $\overline{\alpha}_{m}$ に関する偏微分は次のとおり求まる：
\begin{align}
&\frac{\partial p_3(\overline{\alpha}_{m})}{\partial \overline{\alpha}_{m}}  = \frac{X_{km}}{\mu_j} F(\overline{\alpha}_{m}),\label{eq3-64}\\
&\frac{\partial p_4(\overline{\alpha}_{m})}{\partial \overline{\alpha}_{m}} =\frac{1}{\mu_j} \sum \limits_{k^{\prime} \in {\cal K}_j} \left( \left( \overline{\gamma}_{k^{\prime}j} \exp V_{k^{\prime}}^{h^{\prime}} \right)^{1/\mu_j} X_{k^{\prime}m} \right) := \frac{1}{ \mu_j } P_5(\overline{\alpha}_{m}).\label{eq3-65}
\end{align}
式\eqref{eq3-64}--\eqref{eq3-65}を用いて，$P_{k|j}$ の $\overline{\alpha}_{m}$ に関する偏微分は，次のとおり表わせられる：
\begin{align}
\frac{\partial P_{k|j}^h}{\partial \overline{\alpha}_{m}} = &\frac{\frac{\partial p_3(\overline{\alpha}_{m})}{\partial \overline{\alpha}_{m}}p_4(\overline{\alpha}_{m}) - \frac{\partial p_4(\overline{\alpha}_{m})}{\partial \overline{\alpha}_{m}}p_3(\overline{\alpha}_{m})}{p_4(\overline{\alpha}_{m})^2} = \frac{P_{k|j}}{\mu_j} \left( X_{km} - \frac{p_5(\overline{\alpha}_{m})}{p_4(\overline{\alpha}_{m})} \right). \label{eq3-66}
\end{align}
最後に，式\eqref{eq3-66}を式\eqref{eq3-41}に代入することにより，最終的な対数尤度関数の偏微分は次のとおり表わせられる：
\begin{align}
 \frac{ \partial \mathcal{L}_1 }{\partial \overline{\alpha}_{m}} &= \left[ \sum_{h^{\prime}=1}^{N_h} \sum_{j^{\prime}=1}^{N_j} \sum \limits_{k^{\prime} \in {\cal K}_{j^{\prime}}}  \frac{\delta_{k^{\prime}|j^{\prime}}^{h^{\prime}} X_{k^{\prime}m}}{\mu_{j^{\prime}}} - \sum_{h^{\prime}=1}^{N_h} \sum_{j^{\prime}=1}^{N_j} \sum \limits_{k^{\prime} \in {\cal K}_j} \frac{P_{k^{\prime}|j^{\prime}}^{h^{\prime}} X_{k^{\prime}m}}{\mu_{j^{\prime}}} \right],~\forall m \Rightarrow \eqref{eq3-33}. \label{eq3-67}
\end{align}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{$\overline{\alpha}_{0k}$ に関する ${\cal L}_1$ の偏微分}
$\overline{\alpha}_{m}$ と同様の手順で最終的な偏微分を導こう．ここで注意すべきは，$\overline{\alpha}_m$ は $j,k$ 共通であるのに対し，$\overline{\alpha}_{0k}$ は $k$ により異なるという点である．
$p_3, p_4$ 各項の $\overline{\alpha}_{0k}$ に関する偏微分は次のとおり求まる：
\begin{align}
&\frac{\partial p_3(\overline{\alpha}_{0k})}{\partial \overline{\alpha}_{0k}} = \frac{\partial p_4(\overline{\alpha}_{0k})}{\partial \overline{\alpha}_{0k}} = \frac{p_3(\overline{\alpha}_{0k})}{\mu_j}. \label{eq3-68}
\end{align}
式\eqref{eq3-68}を用いて，$P_{k|j}$ の $\overline{\alpha}_{0k}$ に関する偏微分は，次のとおり表わせられる：
\begin{align}
\frac{\partial P_{k|j}^h}{\partial \overline{\alpha}_{0k}} = \frac{P_{k|j}^h}{\mu_j} \left(1 - P_{k|j}^h \right). \label{eq3-69}
\end{align}
最後に，式\eqref{eq3-69}を式\eqref{eq3-41}に代入することにより，最終的な対数尤度関数の偏微分は次のとおり表わせられる：
\begin{align}
\frac{ \partial \mathcal{L}_1 }{\partial \overline{\alpha}_{0k}} = \left[ \sum_{h^{\prime}=1}^{N_h} \sum_{j^{\prime}=1}^{N_j} \frac{\delta_{k|j^{\prime}}^{h^{\prime}}}{\mu_{j^{\prime}}} - \sum_{h^{\prime}=1}^{N_h} \sum_{j^{\prime}=1}^{N_j} \frac{P_{k|j^{\prime}}^{h^{\prime}}}{\mu_{j^{\prime}}} \right],~\forall k \Rightarrow \eqref{eq3-34}. \label{eq3-70}
\end{align}
ここで $\sum_{k^{\prime} \in {\cal K}_j}$ が式中より消えているのは，この条件が任意の $k$ について成立するためである．
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{$\overline{\gamma}_{kj}$ に関する ${\cal L}_1$ の偏微分}
$p_3, p_4$ 各項の $\overline{\gamma}_{kj}$ に関する偏微分は次のとおり求まる：
\begin{align}
&\frac{\partial p_3(\overline{\gamma}_{kj} )}{\partial \overline{\gamma}_{kj}}=\frac{\partial p_4(\overline{\gamma}_{kj} )}{\partial \overline{\gamma}_{kj}} = \frac{p_3(\overline{\gamma}_{kj} )}{\overline{\gamma}_{kj} \mu_j}. \label{eq3-71}
\end{align}
式\eqref{eq3-71}を用いて，$P_{k|j}$ の $\overline{\gamma}_{kj}$ に関する偏微分は，次のとおり表わせられる：
\begin{align}
\frac{\partial P_{k|j}^h}{\partial \overline{\gamma}_{kj}} = \frac{P_{k|j}^h}{\overline{\gamma}_{kj} \mu_j}  \left(1 - P_{k|j}^h \right). \label{eq3-72}
\end{align}
最後に，式\eqref{eq3-72}を式\eqref{eq3-41}に代入することにより，最終的な対数尤度関数の偏微分は次のとおり表わせられる：
\begin{align}
\frac{ \partial \mathcal{L}_1 }{\partial \overline{\gamma}_{kj}} = \frac{1}{\overline{\gamma}_{kj} \mu_j} \left[ \sum_{h^{\prime}=1}^{N_h} \delta_{k|j}^{h^{\prime}} - \sum_{h^{\prime}=1}^{N_h} P_{k|j}^{h^{\prime}} \right],~\forall (k,j) \Rightarrow  \eqref{eq3-35}. \label{eq3-73}
\end{align}
ここで，$\sum_{j^{\prime}=1}^{N_j}, \sum_{k^{\prime} \in {\cal K}}$ が式中より消えているのは，任意の $(k,j)$ ペアについて，この条件が成立するためである．%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{$\overline{\mu}_{j}$ に関する ${\cal L}_2$ の偏微分}
$\overline{\mu}_{j}$ に関する ${\cal L}_2$ の偏微分を求める際に注意すべきは，確率 $P_j^h$ がここでは，
\begin{align}
P_j^h=  \frac{\left( \sum \limits_{k^{\prime} \in N_j} \left(\gamma_{k^{\prime}j}\exp{V_{k^\prime}^h}\right)^{1/\mu_j}\right)^{\overline{\mu}_j}}
{\sum \limits_j {\left( \sum \limits_{k^{\prime} \in N_j} \left(\gamma_{k^{\prime}j}\exp{V_{k^\prime}^h}\right)^{1/\mu_j}\right)^{\overline{\mu}_j}}}:=\frac{p_1(\overline{\mu}_j)}{p_2(\overline{\mu}_j)} \label{eq3-74}
\end{align}
となることである．内側の $\mu_j$ は一段階目で定めた $j$ ごとの $0$ ではない定数であり，ここでは変数ではない．

$p_1,p_2$ 各項の $\overline{\mu}_{j}$ に関する偏微分は次のとおり求まる：
\begin{align}
\frac{\partial p_1(\overline{\mu}_j)}{\partial \overline{\mu}_{j}} = \frac{\partial p_2(\overline{\mu}_j)}{\partial \overline{\mu}_{j}} = p_1(\overline{\mu}_j) \ln p_4. \label{eq3-75}
\end{align}
式\eqref{eq3-75}を用いて，$P_j$ の $\overline{\mu}_{j}$ に関する偏微分は，次のとおり表わせられる：
\begin{align}
\frac{\partial P_j^h}{\partial \overline{\mu}_{j}} = & \frac{\frac{\partial p_1(\overline{\mu}_j)}{\partial \overline{\mu}_{j}}p_2(\overline{\mu}_j)-\frac{\partial p_2(\overline{\mu}_j)}{\partial \overline{\mu}_{j}}P_1(\overline{\mu}_j)}{p_2(\overline{\mu}_j)^2} P_j^h (1-P_j^h) \ln p_4. \label{eq3-76}
\end{align}
最後に，式\eqref{eq3-76}を式\eqref{eq3-42}に代入することにより，最終的な対数尤度関数の偏微分は次のとおり表わせられる：
\begin{align}
\frac{ \partial \mathcal{L}_2 }{\partial \overline{\mu}_{j}} & =  \left[ \sum_{h^{\prime}=1}^{N_h} \delta_{j}^{h^{\prime}} \ln p_4  - \sum_{h^{\prime}=1}^{N_h} P_{j}^{h^{\prime}} \ln p_4 \right],~\forall j \Rightarrow \eqref{eq3-36}. \label{eq3-77}
\end{align}
ここで $\sum_{j^{\prime}=1}^{N_j}$ が式中より消えているのは，この条件が任意の $j$ について成立するためである．
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
