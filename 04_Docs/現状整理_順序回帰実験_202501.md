# 順序回帰実験 現状整理

**作成日**: 2025年1月14日  
**目的**: 論文執筆に向けた現状の整理

---

## ✅ 完了している作業

### 1. 順序回帰モデルの学習

#### 最新モデル（2025年1月14日）
- **モデルファイル**: `class_level_ordinal_llp_20260114_101852.pth`
- **Test weighted KL**: **0.0935**（改善）
- **学習設定**:
  - エポック数: 3
  - バッチサイズ: 2
  - 学習率: 2e-5
  - ベースモデル: koheiduck/bert-japanese-finetuned-sentiment

#### 旧モデル（2025年10月30日）
- **モデルファイル**: `class_level_ordinal_llp_20251030_162353.pth`
- **Test weighted KL**: 0.1196
- **論文に記載されている値**: この値が記載されている（更新が必要）

### 2. モデル構造の改善

#### 変更内容
- ✅ **`course_head`（授業評価スコアの回帰ヘッド）を削除**
- ✅ **授業評価スコアを期待値から計算**: `E[y] = 1×P1 + 2×P2 + 3×P3 + 4×P4`
- ✅ **損失関数の簡素化**: `loss = kl_loss + ALPHA_SENT * sent_loss`
  - `ALPHA_SENT = 0.3`（補助情報として小さめの重み）

#### モデル構成
```
入力: 授業の全自由記述（集団レベル）
  ↓
[BERTエンコーダー] ← 共有エンコーダー
  ↓
[プールされた特徴量]
  ↓
  ├─→ [OrdinalHead] → P1, P2, P3, P4（確率分布）← 主目的
  │       ↓
  │   KL損失（回答者数重み付け）
  │
  └─→ [sent_head] → 感情スコア（スカラー）← 補助情報
          ↓
      MSE損失（重み: 0.3）

授業評価スコア = E[y] = 1×P1 + 2×P2 + 3×P3 + 4×P4（期待値から計算）
```

### 3. SHAP分析スクリプトの準備

#### テスト実行（完了）
- **スクリプト**: `test_ordinal_shap_small.py`
- **サンプル数**: 10件
- **結果**: ✅ 成功
  - P2（中低評価確率）: 833語
  - P4（高評価確率）: 833語
  - 感情スコア: 833語
  - 授業評価スコア: 833語

#### 本番実行（準備完了）
- **スクリプト**: `analyze_ordinal_shap_production.py`
- **分析種類**: P2とP4のみ（2種類）
- **サンプル数**: 1,000件
- **出力先**: `03_分析結果/順序回帰SHAP分析_P2P4/`
- **推定実行時間**: 約1時間44分

---

## ⏳ 実行待ちの作業

### 1. P2とP4のSHAP分析（本番実行）

#### 実行内容
- **P2（中低評価確率）のSHAP分析**: 2点を減らす要因を特定
- **P4（高評価確率）のSHAP分析**: 4点を増やす要因を特定

#### 出力ファイル
- `word_importance_p2_production.csv`
- `word_importance_p4_production.csv`
- `p2_top30_factors_production.png`
- `p4_top30_factors_production.png`
- `p2_p4_comparison_production.png`
- `ordinal_shap_analysis_summary_production.md`

### 2. 順序回帰モデルの包括的評価

#### 評価スクリプト
- **スクリプト**: `evaluate_ordinal_model.py`（作成済み、未実行）

#### 評価項目
1. KL損失（確率分布の評価）
2. 確率分布の評価（P1～P4のMAE、RMSE）
3. 期待値E[y]の評価（RMSE、MAE、R²、相関係数）
4. 感情スコアの評価（RMSE、MAE、R²、相関係数）
5. 順序性の評価（順序一致率、順序距離誤差）
6. カテゴリ別評価（高評価/低評価/中評価の予測精度）

---

## 📝 論文執筆の現状

### 1. 論文ファイル

#### メインファイル
- **`.卒論.tex`**: メインの卒論ファイル（1,589行）
- **`卒論_編集用.md`**: Markdown版の編集用ファイル（1,186行）

#### 論文の構成
- 第1章: はじめに
- 第2章: 関連研究
- 第3章: 研究方法
- 第4章: マルチタスク学習による関係性の理解
- 第5章: 順序回帰モデルによる改善（← ここを更新）

### 2. 順序回帰モデルの記載状況

#### 現在の記載（古い情報）
- **Test weighted KL**: 0.1196（旧モデルの値）
- **モデルファイル**: `class_level_ordinal_llp_20251030_162353.pth`

#### 更新が必要な内容
- ✅ **Test weighted KL**: 0.1196 → **0.0935**（最新モデル）
- ✅ **モデルファイル**: `class_level_ordinal_llp_20251030_162353.pth` → `class_level_ordinal_llp_20260114_101852.pth`
- ✅ **モデル構造**: 回帰ヘッド削除、期待値計算への変更を記載
- ⏳ **SHAP分析結果**: P2とP4の分析結果を追加（実行待ち）

---

## 🎯 論文執筆の次のステップ

### ステップ1: SHAP分析の実行（最優先）

#### 実行コマンド
```powershell
cd 00_スクリプト
python analyze_ordinal_shap_production.py
```

#### 期待される結果
- P2（2点を減らす要因）の重要語リスト
- P4（4点を増やす要因）の重要語リスト
- 教師の視点に立った改善提案の根拠

### ステップ2: 順序回帰モデルの評価

#### 実行コマンド
```powershell
cd 00_スクリプト
python evaluate_ordinal_model.py
```

#### 期待される結果
- 包括的な評価指標（RMSE、MAE、R²、相関係数など）
- 順序性の評価（順序一致率など）
- カテゴリ別評価（高評価/低評価/中評価の予測精度）

### ステップ3: 論文の更新

#### 更新箇所
1. **第5章 順序回帰モデルによる改善**
   - 学習結果の更新（Test weighted KL: 0.0935）
   - モデル構造の説明（回帰ヘッド削除、期待値計算）
   - SHAP分析結果の追加（P2とP4の分析）

2. **第6章 各評価段階での要因分析**
   - P2（2点を減らす要因）の分析結果
   - P4（4点を増やす要因）の分析結果
   - 教師の視点に立った改善提案

---

## 📊 研究の流れ（論文での記述）

### 第1段階: 単一タスクモデル
- 各タスクを個別に学習
- 感情分析: Accuracy 77.0%
- 評価スコア予測: R² = 0.016（限界を発見）

### 第2段階: マルチタスクモデル
- 感情スコアと授業評価スコアを同時予測
- タスク間干渉による性能低下を発見
- 評価スコアを連続値として扱う課題を発見
- **2点がどのような要因があるか**と**4点がどのような要因があるか**を区別できない

### 第3段階: 順序回帰モデル（マルチタスク学習の改善版、本研究の提案）
- マルチタスク学習の一種（感情スコア + 確率分布）
- 順序性を考慮したモデリング（CORAL型順序回帰）
- 確率分布（P1～P4）を直接予測
- 2種類の要因分離を実現：
  1. 各評価段階を分ける要因（4, 3, 2, 1の分離）
  2. 高評価と低評価を分ける要因（4・3と2・1の分離）
- 教師の視点：2点を減らす要因と4点を増やす要因を明確に特定
- 平均3点の改善戦略を実現可能
- **2点と4点のSHAP分析が可能**（`predict_p2`と`predict_p4`関数を使用）

---

## 🔬 順序回帰モデルの目的（論文での記述）

### 1. 教師の視点：平均3点の改善戦略

**核心的な問題意識**:
- 授業評価スコアの平均は約3点である
- 教師側からしたら、**2点のものを減らして、4点のものを増やしたい**
- しかし、従来のマルチタスク学習では、**2点がどのような要因があるか**と**4点がどのような要因があるか**を区別することが困難であった

**順序回帰モデルの解決策**:
- 確率分布（P1, P2, P3, P4）を直接予測することで、各評価段階の要因を分離可能
- **P4（4点確率）への寄与** → 4点を増やす要因を特定
- **P2（2点確率）への寄与** → 2点を減らす要因を特定

### 2. 2種類の要因分離

#### 2-1. 各評価段階を分ける要因（4, 3, 2, 1の分離）
- **P4（4点確率）への寄与**: 4点を増やす要因
- **P2（2点確率）への寄与**: 2点を減らす要因（**教師の最重要課題**）

#### 2-2. 高評価と低評価を分ける要因（4・3と2・1の分離）
- **P4・P3（高評価確率）への寄与**: 高評価を増やす要因
- **P2・P1（低評価確率）への寄与**: 低評価を減らす要因（**教師の最重要課題**）

---

## 📌 論文執筆の優先順位

### 最優先（今すぐ実行）
1. ✅ **P2とP4のSHAP分析を実行**
   - 実行時間: 約1時間44分
   - 論文の核心的な結果が得られる

### 高優先（SHAP分析完了後）
2. ✅ **順序回帰モデルの包括的評価を実行**
   - 実行時間: 約10-20分
   - 論文の評価指標を補完

3. ✅ **論文の更新**
   - 学習結果の更新（Test weighted KL: 0.0935）
   - SHAP分析結果の追加
   - モデル構造の説明

### 中優先（論文執筆中）
4. ⏳ **結果の分析と可視化**
5. ⏳ **マルチタスクモデルとの比較**
6. ⏳ **卒論用の実験結果まとめ**

---

## 📋 チェックリスト

### 実験関連
- [x] 順序回帰モデルの学習完了（Test weighted KL: 0.0935）
- [x] モデル構造の改善（回帰ヘッド削除、期待値計算）
- [x] SHAP分析スクリプトの準備（P2とP4のみ）
- [ ] **P2とP4のSHAP分析実行** ← 今すぐ実行
- [ ] 順序回帰モデルの包括的評価実行

### 論文執筆関連
- [ ] 学習結果の更新（Test weighted KL: 0.0935）
- [ ] モデル構造の説明追加
- [ ] SHAP分析結果の追加（P2とP4）
- [ ] 教師の視点に立った改善提案の記述

---

## 🎯 次のアクション

1. **P2とP4のSHAP分析を実行**（約1時間44分）
2. **順序回帰モデルの包括的評価を実行**（約10-20分）
3. **論文の更新**（SHAP分析結果を反映）

---

**最終更新**: 2025年1月14日

