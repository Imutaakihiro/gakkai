# PowerShellスクリプトの文字エンコーディング問題の根本原因

## 問題の症状

- 日本語文字が文字化けする（例：「ｫ縺励∪縺呻ｼ・UDA 12.1縺悟ｿ・ｦ√↑蝣ｴ蜷医・謇句虚縺ｧ螟画峩縺励※縺上□縺輔＞・・」）
- PowerShellの構文エラーが発生する
- ファイルは正しく保存されているように見えるが、実行時にエラーになる

## 根本原因

### 1. PowerShellの文字エンコーディングの仕様

PowerShellは、スクリプトファイルを読み込む際に以下の優先順位でエンコーディングを判定します：

1. **BOM（Byte Order Mark）の有無**
   - UTF-8 BOM（EF BB BF）
   - UTF-16 LE BOM（FF FE）
   - UTF-16 BE BOM（FE FF）

2. **BOMがない場合**
   - PowerShell 5.1以前：システムのデフォルトエンコーディング（Windowsでは通常Shift-JIS）
   - PowerShell 7以降：UTF-8

### 2. 問題が発生するケース

- **UTF-8 BOMなしで保存されたファイル**
  - 多くのエディタ（VSCode、Cursor等）はデフォルトでUTF-8 BOMなしで保存
  - PowerShell 5.1では、BOMがない場合、Shift-JISとして解釈される
  - 結果：UTF-8で保存された日本語がShift-JISとして解釈され、文字化け

- **Shift-JISで保存されたファイル**
  - 古いエディタやWindows標準のメモ帳で保存した場合
  - PowerShell 7ではUTF-8として解釈される可能性
  - 結果：文字化け

### 3. 現在の問題

`fix_pytorch.ps1`がUTF-8 BOMなしで保存されている可能性が高いです。
PowerShell 5.1がこのファイルをShift-JISとして解釈しようとし、文字化けが発生しています。

## 解決方法

### 方法1: UTF-8 BOMで保存（推奨）

PowerShellスクリプトは**UTF-8 BOM**で保存する必要があります。

**VSCode/Cursorでの設定：**
1. ファイルを開く
2. 右下のエンコーディング表示をクリック
3. "Save with Encoding" を選択
4. "UTF-8 with BOM" を選択

**PowerShellで直接変換：**
```powershell
$content = Get-Content "fix_pytorch.ps1" -Raw -Encoding UTF8
[System.IO.File]::WriteAllText("fix_pytorch.ps1", $content, [System.Text.Encoding]::UTF8)
```

### 方法2: PowerShell 7を使用

PowerShell 7（PowerShell Core）はデフォルトでUTF-8をサポートしているため、BOMなしでも動作します。

### 方法3: エディタの設定を変更

VSCode/Cursorの設定で、PowerShellファイルを自動的にUTF-8 BOMで保存するように設定：

```json
{
  "files.encoding": "utf8bom",
  "[powershell]": {
    "files.encoding": "utf8bom"
  }
}
```

## 確認方法

ファイルのエンコーディングを確認：

```powershell
$bytes = [System.IO.File]::ReadAllBytes("fix_pytorch.ps1")
$bom = $bytes[0..2] -join ', '
if ($bytes[0] -eq 0xEF -and $bytes[1] -eq 0xBB -and $bytes[2] -eq 0xBF) {
    Write-Host "UTF-8 BOM: OK"
} else {
    Write-Host "BOMなし: 問題あり"
}
```

## 推奨される対応

1. **すべてのPowerShellスクリプトをUTF-8 BOMで保存**
2. **エディタの設定でPowerShellファイルは自動的にUTF-8 BOMで保存**
3. **既存のスクリプトを一括で変換**
