# 文字化け問題の根本解決

**作成日**: 2025年1月  
**問題**: バッチファイルをPowerShellで実行すると文字化けが発生

---

## 🔍 根本原因

### 問題の構造
1. **バッチファイル（.bat）**: Shift-JIS（CP932）で保存されることが多い
2. **PowerShell**: UTF-8で読み込もうとする
3. **結果**: 日本語が文字化けする

### なぜ文字化けが発生するのか
- Windowsのコマンドプロンプト（cmd.exe）はShift-JIS（CP932）をデフォルトで使用
- PowerShellはUTF-8をデフォルトで使用
- バッチファイルをPowerShellで実行すると、文字コードの不一致が発生

---

## ✅ 根本解決策

### 解決策1: バッチファイル内で文字コードを明示的に設定

**修正内容**:
```batch
@echo off
chcp 65001 >nul  ← これを追加（UTF-8に設定）
```

**効果**:
- バッチファイル実行時にUTF-8に切り替え
- PowerShellでもコマンドプロンプトでも正しく表示される

### 解決策2: PowerShellスクリプト（.ps1）を作成

**理由**:
- PowerShellはUTF-8をネイティブサポート
- 文字コードの問題が発生しない
- より強力な機能を利用可能

**実装**:
- `setup_venv_ordinal_shap.ps1` を作成
- UTF-8 BOM付きで保存
- PowerShellの機能を活用

---

## 🎯 実装した解決策

### 1. バッチファイルの修正
- `setup_venv_ordinal_shap.bat` の先頭に `chcp 65001 >nul` を追加
- UTF-8で文字を表示するように設定

### 2. PowerShellスクリプトの作成
- `setup_venv_ordinal_shap.ps1` を作成
- UTF-8エンコーディングを明示的に設定
- カラー出力など、PowerShellの機能を活用

---

## 📝 使用方法

### PowerShellで実行（推奨）
```powershell
# 実行ポリシーの確認・変更（初回のみ）
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser

# スクリプトを実行
.\setup_venv_ordinal_shap.ps1
```

### コマンドプロンプトで実行
```cmd
setup_venv_ordinal_shap.bat
```

---

## 🔧 技術的詳細

### chcp 65001 とは
- `chcp`: Change Code Page（コードページ変更）
- `65001`: UTF-8のコードページ番号
- `>nul`: 出力を抑制（エラーメッセージを表示しない）

### PowerShellの実行ポリシー
- **Restricted**: スクリプトの実行が禁止
- **RemoteSigned**: ローカルのスクリプトは実行可能
- **Unrestricted**: すべてのスクリプトが実行可能

---

## ✅ 解決の確認

### 文字化けが解決されたか確認
1. スクリプトを実行
2. 日本語が正しく表示されることを確認
3. エラーメッセージも日本語で正しく表示される

---

## 🎓 学んだこと

### 「きこりのジレンマ」の解決
- **表面的な対処**: 文字化けを無視して進める
- **根本的な解決**: 文字コードの問題を理解し、適切な方法で解決

### 根本原因の特定
1. **問題の現象**: 文字化け
2. **直接的な原因**: 文字コードの不一致
3. **根本原因**: バッチファイルとPowerShellの文字コード設定の違い

### 解決策の選択
- **一時的な対処**: コマンドプロンプトで実行
- **根本的な解決**: 文字コードを明示的に設定、またはPowerShellスクリプトを作成

---

**最終更新**: 2025年1月

