# 実験を進める（順序回帰・CORALベース）

**作成日**: 2026年1月29日  
**元資料**: 先行研究_CORAL_20260129.md、順序回帰実験_再開タスク_20260129.md

---

## 現状のブロッカー

1. **順序回帰モデル `.pth` が無い**
   - 想定パス: `02_モデル/授業レベルマルチタスクモデル/class_level_ordinal_llp_20260114_101852.pth`
   - 現状: `02_モデル` 配下に「授業レベルマルチタスクモデル」フォルダはなく、`.pth` も存在しない。

2. **対応の二択**
   - **A) モデルを別環境から持ってくる**: `.pth` を上記パスに配置すれば、そのまま **フェーズ1（SHAP本番）** に進める。
   - **B) 再学習する**: 下記の **ステップ1〜3** を順に実行する。

---

## 実験を進める手順（B: 再学習する場合）

### ステップ1: 回答分布付きデータの作成 ✅ 完了（2026-01-29）

- **目的**: 順序回帰の教師データとして、1〜4点の回答分布（人数・割合）が入った授業集約CSVを作る。
- **スクリプト**: `00_スクリプト/create_course_aggregated_dataset.py`（`parse_distribution` / `parse_survey_info` 追加済み、絶対パス対応）
- **出力**: `01_データ/マルチタスク用データ/授業集約データセット_20260129_134018.csv`（3,268授業、`分布_十分意義あり_人数` 等の列あり）
- **実行例**: gakkai 直下で `venv\Scripts\python.exe run_create_agg.py`（日本語パス回避用ランナー）

### ステップ2: 順序回帰モデルの学習（CORAL型）

- **目的**: 授業単位で P1〜P4 を予測する順序回帰モデルを学習し、`.pth` を保存する。
- **スクリプト**: `00_スクリプト/train_class_level_ordinal_llp.py`
- **データ**: ステップ1で作成した「回答分布付き」CSV（または `授業集約データセット_*.csv` の最新）。  
  **重要**: `分布_*_人数` または `分布_*_割合(%)` の列がないと学習は失敗する。
- **保存先**: `02_モデル/授業レベルマルチタスクモデル/class_level_ordinal_llp_YYYYMMDD_HHMMSS.pth`
- **実行**（`その他` をカレントに。スクリプトが `02_モデル` 等を相対パスで参照するため）:
  ```powershell
  cd C:\Users\mkmzk\Desktop\gakkai\その他
  python 00_スクリプト/train_class_level_ordinal_llp.py
  ```
- **参照**: 手法の理論的根拠は CORAL（Cao et al., Pattern Recognition Letters 2020）。  
  先行研究メモ: `その他/先行研究_CORAL_20260129.md`

### ステップ3: P2・P4 の SHAP 本番実行

- **目的**: 2点を減らす要因（P2）と4点を増やす要因（P4）の語彙重要度を算出する。
- **スクリプト**: `00_スクリプト/analyze_ordinal_shap_production.py`
- **モデル**: ステップ2で保存した `.pth` のパスを、スクリプト内の `MODEL_PATH` で指定する。  
  （日時付きファイル名になるため、必要ならスクリプトのファイル名を最新のものに書き換える）
- **データ**: `01_データ/マルチタスク用データ/` 内の授業集約CSV（「回答分布付き」でなくても可。`自由記述まとめ` があればよい）
- **出力先**: `03_分析結果/順序回帰SHAP分析_P2P4/`
- **実行**（`その他/00_スクリプト` で）:
  ```powershell
  cd C:\Users\mkmzk\Desktop\gakkai\その他\00_スクリプト
  python analyze_ordinal_shap_production.py
  ```
- **所要時間目安**: 約1時間44分（1,000件サンプル）

---

## まとめ

| 順番 | やること           | スクリプト                          | ブロッカー解消 |
|------|--------------------|-------------------------------------|----------------|
| 1    | 回答分布付きデータ作成 | `create_course_aggregated_dataset.py` | 学習用データ   |
| 2    | 順序回帰モデル学習     | `train_class_level_ordinal_llp.py`   | `.pth` の作成  |
| 3    | P2/P4 SHAP本番      | `analyze_ordinal_shap_production.py` | 結果の取得     |

- **モデルを既に持っている場合（A）**: ステップ1・2は飛ばし、ステップ3のスクリプト内 `MODEL_PATH` をその `.pth` に合わせてから実行する。
- **CORAL論文**: 引用・BibTeX は `その他/先行研究_CORAL_20260129.md` を参照。
