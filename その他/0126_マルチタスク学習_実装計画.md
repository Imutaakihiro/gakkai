# マルチタスク学習の実行 実装計画

**作成日**: 2026年1月26日  
**目的**: Daily/0126.mdのタスク「マルチタスク学習の実行」を実装する

---

## 📋 概要

- **目的**: 順序回帰（P1-P4の確率分布予測）と感情スコア予測のマルチタスク学習を実行
- **推定実行時間**: 1-2時間（GPU環境の場合）
- **優先度**: 高優先

---

## 🔍 ステップ1: 環境の確認

### 1.1 Python環境の確認

```powershell
# プロジェクトルートに移動
cd C:\Users\mkmzk\Desktop\gakkai

# Pythonバージョン確認
python --version
# 期待される出力: Python 3.8以上
```

### 1.2 仮想環境の確認・作成

```powershell
# 仮想環境の存在確認
Test-Path "venv"

# 仮想環境が存在しない場合、セットアップスクリプトを実行
cd "その他\00_スクリプト"
.\setup_environment.ps1
```

### 1.3 仮想環境の有効化

```powershell
# プロジェクトルートに戻る
cd C:\Users\mkmzk\Desktop\gakkai

# 仮想環境を有効化
.\venv\Scripts\Activate.ps1

# ライブラリの確認
python -c "import torch; import transformers; print('PyTorch:', torch.__version__); print('Transformers:', transformers.__version__)"
```

**期待される出力**:
- PyTorch: 2.x.x
- Transformers: 4.x.x

---

## 📁 ステップ2: データの準備

### 2.1 データファイルの確認

```powershell
# データファイルの検索
Get-ChildItem -Recurse -Filter "*授業集約データセット*.csv" | Select-Object FullName
```

**必要なデータファイル**:
- `01_データ/マルチタスク用データ/授業集約データセット 回答分布付き.csv`（優先）
- または `授業集約データセット_*.csv` の最新ファイル

**必要な列**:
- `自由記述まとめ` または `text`（テキスト列）
- `count_1`, `count_2`, `count_3`, `count_4` または `ratio_1`, `ratio_2`, `ratio_3`, `ratio_4`（回答分布）
- `respondents` または `回答者数`（回答者数）
- `感情スコア平均` または `sentiment_mean`（感情スコア）
- `授業評価スコア` または `course_score`（授業評価スコア）
- `course_id` または `授業ID`（授業ID）

### 2.2 データの前処理確認

スクリプト `train_class_level_ordinal_llp.py` が自動的に以下を実行します：
- データの読み込み
- 回答分布の正規化（count → ratio）
- 訓練・検証・テストセットの分割（70:15:15、ランダム）

---

## ⚙️ ステップ3: モデルの設定確認

### 3.1 モデルアーキテクチャ

スクリプト: `その他/00_スクリプト/train_class_level_ordinal_llp.py`

**モデル構造**:
- **BERTエンコーダー（共有）**: `koheiduck/bert-japanese-finetuned-sentiment`
- **OrdinalHead**: P1, P2, P3, P4の確率分布予測（累積ロジットモデル）
- **sent_head**: 感情スコア予測（回帰）

### 3.2 ハイパーパラメータ

現在の設定（`train_class_level_ordinal_llp.py`内）:
```python
BASE_MODEL = "koheiduck/bert-japanese-finetuned-sentiment"
MAX_LENGTH = 192
BATCH_SIZE = 2
NUM_EPOCHS = 3
LEARNING_RATE = 2e-5
USE_AMP = True
CHUNK_LEN = 192
STRIDE = 150
MAX_CHUNKS = 4
ALPHA_SENT = 0.3  # 感情スコア損失の重み
```

### 3.3 損失関数

- **KL損失（OrdinalHead用）**: 回答者数で重み付け
  - `KL(q || p̄)` where `p̄` = 授業単位での平均予測分布
- **MSE損失（sent_head用）**: 重み0.3
- **合計損失**: `loss = KL_loss + ALPHA_SENT * MSE_loss`

---

## 🚀 ステップ4: 学習の実行

### 4.1 実行コマンド

**重要**: 以下のコマンドをユーザー自身が実行してください。

```powershell
# プロジェクトルートに移動
cd C:\Users\mkmzk\Desktop\gakkai

# 仮想環境を有効化
.\venv\Scripts\Activate.ps1

# スクリプトディレクトリに移動
cd "その他\00_スクリプト"

# マルチタスク学習を実行
python train_class_level_ordinal_llp.py
```

### 4.2 実行前の確認事項

- [ ] 仮想環境が有効化されている（プロンプトに `(venv)` が表示されている）
- [ ] データファイルが存在する
- [ ] GPU/CPU環境が利用可能（スクリプトが自動検出）
- [ ] 十分なメモリがある（推奨: 8GB以上）

### 4.3 実行中の確認

学習中に以下の情報が表示されます：
- 使用デバイス（CUDA/MPS/DirectML/CPU）
- エポックごとの損失
- ステップごとの進捗

**期待される出力例**:
```
✅ CUDA 利用
📁 使用CSV(優先): 01_データ/マルチタスク用データ/授業集約データセット 回答分布付き.csv
行数: XXX, 列: XX
Epoch 1 | Step 10/XXX | Loss X.XXXX
[Epoch 1] Train X.XXXX | Val X.XXXX
...
🧪 Test KL (weighted): X.XXXX
💾 保存: 02_モデル/授業レベルマルチタスクモデル/class_level_ordinal_llp_YYYYMMDD_HHMMSS.pth
```

### 4.4 実行時間の目安

- **CPU**: 数時間〜半日
- **GPU (CUDA)**: 30分〜2時間
- **DirectML (Windows GPU)**: 1-3時間
- **MPS (Apple Silicon)**: 1-2時間

---

## 📊 ステップ5: 結果の評価

### 5.1 出力ファイル

学習完了後、以下のファイルが生成されます：

1. **モデルファイル**: 
   - `02_モデル/授業レベルマルチタスクモデル/class_level_ordinal_llp_YYYYMMDD_HHMMSS.pth`
   - 学習済みモデルの重み

2. **結果JSONファイル**:
   - `02_モデル/授業レベルマルチタスクモデル/class_level_ordinal_llp_YYYYMMDD_HHMMSS.json`
   - 学習結果と設定情報

### 5.2 評価指標

- **Test weighted KL損失**: 順序回帰タスクの性能（小さいほど良い）
- **学習曲線**: 過学習の有無を確認

### 5.3 検証方法

1. **学習曲線の確認**:
   - Train Loss と Val Loss の推移を確認
   - Val Loss が増加し始めたら過学習の可能性

2. **モデルファイルの確認**:
   - モデルファイルが正しく保存されているか
   - JSONファイルに結果が記録されているか

---

## ⚠️ トラブルシューティング

### メモリ不足エラー

**症状**: `RuntimeError: CUDA out of memory` または類似エラー

**対処法**:
1. `BATCH_SIZE` を減らす（2 → 1）
2. `MAX_CHUNKS` を減らす（4 → 2）
3. `CHUNK_LEN` を減らす（192 → 128）

### データファイルが見つからない

**症状**: `FileNotFoundError: 授業集約データセット_*.csv が見つかりません`

**対処法**:
1. データファイルのパスを確認
2. `train_class_level_ordinal_llp.py` の `AGG_DIR_CANDIDATES` を確認・修正

### ライブラリのインポートエラー

**症状**: `ModuleNotFoundError: No module named 'torch'`

**対処法**:
1. 仮想環境が有効化されているか確認
2. 必要なライブラリをインストール:
   ```powershell
   pip install torch transformers pandas numpy scikit-learn
   ```

---

## 📝 次のステップ

学習完了後：
1. 学習結果をDailyメモに記録
2. SHAP分析の実装に進む（タスク2）
3. 必要に応じてモデルの再学習

---

## 🔗 関連ファイル

- `その他/00_スクリプト/train_class_level_ordinal_llp.py`: 学習スクリプト
- `その他/00_スクリプト/multitask_model.py`: モデル定義（参考）
- `Daily/0126.md`: 今日のDailyメモ
- `その他/0126実装フロー.md`: 詳細な実装フロー

---

**最終更新**: 2026年1月26日
