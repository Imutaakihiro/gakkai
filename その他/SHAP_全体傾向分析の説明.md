# SHAP分析: 全体傾向の抽出方法

## 🎯 目的

**個別の文ではなく、データセット全体での傾向を知りたい**

```
質問: 学生が満足する授業には、一般的にどんな言葉が使われる？
回答: 全200件の自由記述を分析した結果...
```

---

## 📊 具体的な分析手順

### ステップ1: 全データでSHAP値を計算

```python
# 検証データ全件（例: 200件）でSHAP分析
texts = val_df['text'].tolist()  # 200件のテキスト

# SHAP分析
explainer = shap.Explainer(predict, tokenizer)
shap_values = explainer(texts)  # 全200件を一度に分析
```

**結果:**
- 200件 × 各文の単語数分のSHAP値が得られる

---

### ステップ2: 単語ごとに集計

```python
# 各単語の重要度を集計
単語          出現回数    平均SHAP値    SHAP絶対値の平均
─────────────────────────────────────────────────────
わかりやすい    45回      +0.42        0.42
楽しい          38回      +0.38        0.38
つまらない      22回      -0.45        0.45
難しい          56回      -0.42        0.42
普通            89回      +0.05        0.15
```

**重要な指標:**
- **平均SHAP値**: プラス/マイナスの方向（ポジティブ/ネガティブ）
- **SHAP絶対値の平均**: 影響の大きさ（方向関係なく）
- **出現回数**: データ内での頻度

---

### ステップ3: ランキング作成

#### 📈 ポジティブ判定に最も寄与する単語 TOP20

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
全200件の分析結果（ポジティブ方向）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
順位  単語              平均SHAP  出現回数  影響度
──────────────────────────────────────────────────
1     わかりやすい      +0.42     45件     ★★★★★
2     楽しい/楽しく     +0.38     38件     ★★★★★
3     面白い            +0.35     31件     ★★★★
4     丁寧              +0.28     27件     ★★★★
5     興味深い          +0.26     24件     ★★★
6     充実              +0.24     19件     ★★★
7     良い/よい         +0.22     52件     ★★★
8     役立つ            +0.20     18件     ★★★
9     熱心              +0.18     15件     ★★
10    満足              +0.17     12件     ★★
11    工夫              +0.16     14件     ★★
12    理解しやすい      +0.15     11件     ★★
13    勉強になる        +0.14     23件     ★★
14    ためになる        +0.13     16件     ★★
15    親切              +0.12     9件      ★★
16    実用的            +0.12     13件     ★★
17    刺激的            +0.11     8件      ★★
18    有意義            +0.11     10件     ★★
19    効率的            +0.10     7件      ★
20    魅力的            +0.10     6件      ★
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

**解釈:**
- 「わかりやすい」が最も強くポジティブ判定に寄与
- 45件のテキストに出現し、平均SHAP値+0.42
- 学生満足度を高めるには「わかりやすさ」が最重要

---

#### 📉 ネガティブ判定に最も寄与する単語 TOP20

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
全200件の分析結果（ネガティブ方向）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
順位  単語                平均SHAP  出現回数  影響度
──────────────────────────────────────────────────
1     つまらない          -0.45     22件     ★★★★★
2     難しすぎる          -0.42     34件     ★★★★★
3     わかりにくい        -0.40     28件     ★★★★★
4     退屈                -0.38     18件     ★★★★
5     興味がない          -0.35     16件     ★★★★
6     ついていけない      -0.32     24件     ★★★★
7     大変                -0.30     41件     ★★★
8     適当                -0.28     12件     ★★★
9     不満                -0.26     9件      ★★★
10    役に立たない        -0.24     11件     ★★★
11    無駄                -0.22     8件      ★★
12    意味がない          -0.21     7件      ★★
13    下手                -0.20     10件     ★★
14    早すぎる            -0.19     13件     ★★
15    理解できない        -0.18     15件     ★★
16    雑                  -0.17     6件      ★★
17    つらい              -0.16     9件      ★
18    苦痛                -0.15     5件      ★
19    眠い                -0.14     14件     ★
20    飽きる              -0.13     8件      ★
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

**解釈:**
- 「つまらない」「難しすぎる」「わかりにくい」が不満の主要因
- これらが出現すると高確率でネガティブ判定

---

### ステップ4: クラス別の傾向分析

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
クラス別 特徴語の傾向
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

【ポジティブ（28件）】
最頻出語: わかりやすい, 楽しい, 面白い
特徴: 「楽しさ」「理解しやすさ」を示す語が頻出

【ニュートラル（132件）】
最頻出語: 普通, まあまあ, 特に〜ない
特徴: 中立的・無感情的な表現が多い

【ネガティブ（40件）】
最頻出語: つまらない, 難しい, わかりにくい
特徴: 「難易度」「退屈さ」を示す語が頻出
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

---

## 📈 可視化例

### 図1: 重要語ランキング（棒グラフ）

```
ポジティブ方向への寄与度

わかりやすい  ██████████████████████ 0.42
楽しい        ████████████████████   0.38
面白い        ██████████████████     0.35
丁寧          ██████████████         0.28
興味深い      █████████████          0.26
充実          ████████████           0.24
良い          ███████████            0.22
役立つ        ██████████             0.20
```

### 図2: ワードクラウド

```
             わかりやすい
    楽しい              面白い
       丁寧    興味深い
  充実              良い
       役立つ    熱心
```

大きい文字 = SHAP値が高い（重要）

### 図3: ヒートマップ（クラス × 単語）

```
            ポジ  ニュートラル  ネガ
わかりやすい  🟩       🟨        🟥
楽しい        🟩       🟨        🟥
つまらない    🟥       🟨        🟩
難しい        🟥       🟨        🟩
普通          🟨       🟩        🟨
```

🟩 = 高い寄与, 🟨 = 中程度, 🟥 = 低い寄与

---

## 🎓 卒論での活用

### 5章 結果（SHAP分析）

```
5.3 感情分析の解釈可能性

全200件の検証データに対してSHAP分析を実施し、
感情判定に寄与する語彙を特定した。

表X: ポジティブ判定に最も寄与する語（TOP10）
[上記のランキング表を挿入]

図Y: 重要語の可視化
[ワードクラウドまたは棒グラフを挿入]

分析の結果、以下が明らかになった：

1. 満足度が高い授業の特徴
   - 「わかりやすさ」(平均SHAP +0.42)
   - 「楽しさ」(平均SHAP +0.38)
   - 「興味深さ」(平均SHAP +0.26)

2. 不満に繋がる要因
   - 「つまらない」(平均SHAP -0.45)
   - 「難しすぎる」(平均SHAP -0.42)
   - 「わかりにくい」(平均SHAP -0.40)

3. 教育実践への示唆
   授業設計において、「わかりやすさ」と「楽しさ」を
   両立させることが学生満足度向上の鍵となる。
```

---

## 💻 実装コード（全体傾向）

```python
import shap
import pandas as pd
import numpy as np
from collections import defaultdict

# 1. 全データでSHAP分析
texts = val_df['text'].tolist()  # 200件
shap_values = explainer(texts)

# 2. 単語ごとに集計
word_shap = defaultdict(list)

for i, text in enumerate(texts):
    tokens = tokenizer.tokenize(text)
    shap_vals = shap_values[i].values
    
    # サブワードを語に統合しながら集計
    for token, shap_val in zip(tokens, shap_vals):
        # ##を除去して語に統合
        word = token.replace("##", "")
        word_shap[word].append(shap_val)

# 3. 平均SHAP値を計算
word_importance = {}
for word, vals in word_shap.items():
    word_importance[word] = {
        'mean_shap': np.mean(vals),
        'abs_mean_shap': np.mean(np.abs(vals)),
        'count': len(vals)
    }

# 4. ランキング作成
df_importance = pd.DataFrame(word_importance).T
df_importance = df_importance.sort_values('abs_mean_shap', ascending=False)

print("重要語ランキング TOP20:")
print(df_importance.head(20))

# 5. 可視化
import matplotlib.pyplot as plt

# 棒グラフ
top_words = df_importance.head(20)
plt.barh(top_words.index, top_words['mean_shap'])
plt.xlabel('平均SHAP値')
plt.title('重要語ランキング（全データ）')
plt.tight_layout()
plt.savefig('shap_global_importance.png', dpi=300)
```

---

## ✅ まとめ

### 個別 vs 全体

**個別分析（Local）:**
```
"この文は、なぜポジティブと判定された？"
→ この文の「楽しく」という単語が寄与
```

**全体傾向（Global）:** ← **これが欲しいもの！**
```
"一般的に、どんな単語がポジティブ判定に寄与する？"
→ データセット全体で「わかりやすい」が最重要
→ 45件に出現し、平均SHAP +0.42
```

### 研究での価値

- 📊 **定量的根拠**: 全データでの統計的傾向
- 📈 **実用的提言**: 「わかりやすさ」を重視すべき
- 🎓 **卒論の説得力**: 個別事例ではなく全体傾向で主張

---

**これで「全データからの傾向」が抽出できます！** 🎉

