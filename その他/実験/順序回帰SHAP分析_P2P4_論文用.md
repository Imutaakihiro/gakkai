# 順序回帰モデル SHAP 分析（P2・P4）— 論文用 分析レポート

**目的**: 論文執筆に必要な方法・結果・図表・考察・限界・引用・ファイル参照を一括で記載する。  
**元データ**: `その他/03_分析結果/順序回帰SHAP分析_P2P4/` の CSV・PNG・JSON・既存メモを基に作成。  
**作成日**: 2026-01-29

---

## 1. 論文で使うタイトル・見出し案

- **節タイトル例**: 「順序回帰モデルによる授業評価自由記述のSHAP分析」
- **サブ節例**: 「分析の概要」「P2（中低評価確率）に寄与する語」「P4（高評価確率）に寄与する語」「考察」「限界」

---

## 2. 引用・参考文献（論文に必要なもの）

- **SHAP**: Lundberg, S. M., & Lee, S.-I. (2017). A unified approach to interpreting model predictions. In *Advances in Neural Information Processing Systems 30* (NeurIPS 2017).
- **順序回帰（CORAL）**: Cao, W., Mirjalili, V., & König, S. (2020). Rank-consistent ordinal regression for neural networks. *arXiv preprint*. など、卒論で使用しているCORAL型・LLP損失の文献を記載すること。
- **日本語BERT**: 使用している事前学習モデル（例: cl-tohoku/bert-base-japanese 等）の引用を追加すること。

---

## 3. 方法（論文の「方法」節に書く内容）

### 3.1 モデルと出力

- **モデル**: 授業評価の自由記述を入力とし、1〜4点の順序付き評価を予測する**順序回帰モデル**（CORAL型、LLP損失）。
- **出力**: 各クラス（1点〜4点）の確率。本分析では **P2（2点の確率＝中低評価確率）** と **P4（4点の確率＝高評価確率）** を対象とした。

### 3.2 SHAP 分析の設定

- **手法**: SHAP（Lundberg & Lee, 2017）により、自由記述に含まれる**語（トークン）単位**で、P2・P4の予測への寄与度（重要度）を算出した。
- **解釈**:
  - P2 への SHAP 重要度が**正** → その語が含まれる記述ほど「2点寄り」になりやすい → **低評価に寄与**する語。
  - P4 への SHAP 重要度が**正** → その語が含まれる記述ほど「4点寄り」になりやすい → **高評価に寄与**する語。
- **背景サンプル数**: 1,000 件（SHAP 計算時の背景データ）。
- **語彙数**: 7,795 語（トークン数）。
- **トークン化**: WordPiece（BERT 系）のため、同一語が複数トークンに分割されている場合あり。論文中では「語」と「トークン」を区別して記述するとよい。

### 3.3 分析環境・実施日

- **分析日時**: 2026-01-29 17:18:04（分析ID: 20260129_171804）
- **使用デバイス**: CUDA（GPU）
- **PyTorch version**: 2.5.1+cu121
- **データ**: 授業集約データセット（回答分布付き）の自由記述を入力とした。詳細は `その他/01_データ/マルチタスク用データ/` を参照。

### 3.4 要因の分類

各語について、P2・P4 への SHAP 重要度の絶対値で順位づけし、次のように分類した。

- **強い共通要因**: P2・P4 の両方で重要度が高い語。
- **P2 特化要因**: P2 で重要度が高く、P4 では相対的に低い語（＝「2点を減らす」要因）。
- **P4 特化要因**: P4 で重要度が高く、P2 では相対的に低い語（＝「4点を増やす」要因）。
- **P2 寄り・P4 寄り**: いずれかにより強く寄与する語。

---

## 4. 結果（論文の「結果」節に書く内容）

### 4.1 分析の概要（数値）

| 項目 | 値 |
|------|-----|
| 完了した分析 | P2, P4 の 2 件 |
| P2 予測要因数（語数） | 7,795 |
| P4 予測要因数（語数） | 7,795 |
| **強い共通要因数** | **2 語** |
| **P2 特化要因数** | **1,069 語** |
| **P4 特化要因数** | **0 語** |
| P2 寄り要因数 | 7 語 |
| P4 寄り要因数 | 0 語 |

- **強い共通要因の 2 語**: 「高圧」「圏」（いずれも P2・P4 の両方で重要度が高い）。

### 4.2 強い共通要因（表に使う数値）

| 語 | P2 重要度（2点を減らす） | P4 重要度（4点を増やす） | 総合重要度（参考） |
|----|--------------------------|--------------------------|--------------------|
| 高圧 | 0.00207 | 0.000533 | 0.00260 |
| 圏   | 0.00110 | 0.000539 | 0.00164 |

### 4.3 P2（中低評価確率）に寄与する語

- P2 の SHAP 重要度の**最大値は約 0.008**（トークン「ender」「 bl」等の断片）。意味解釈可能な日本語の語では **クリエイター 0.00748、オブジェクト 0.00533、偏見 0.00435、登山 0.00368、熱い 0.00352** などが上位。
- **不満・困難・否定的評価を表す語**: 苦しむ、ひど、格差、退屈、不便、下手、文句、嫌、批判、残念、難しかっ、未熟、ゴミ、消える、高圧、迷い、陥る、見つから、などが重要度の高い「意味のある語」に含まれた。低評価に結びつきやすい自由記述の内容と整合的である。
- **授業・分野を特徴づける語**: クリエイター、オブジェクト、プログラミング、ゼミ、業界、素材、溶接、刺繍、観光、ロシア など。特定の授業でどのような不満が語られやすいかの手がかりとなる。
- **人間関係・場面**: チームメイト、パートナー、馴染み、配属。「馴染みがない」「配属が合わない」といった否定・不満の文脈での共起が考えられる。
- **注意**: 明るい、希望、楽し、優しい などポジティブ語も P2 に寄与しているように見える語がある。「明るくない」「希望が持てない」など**否定形での共起**の可能性があり、解釈には生テキストの確認が望ましい。

#### 表：P2 に寄与する語の例（意味のある日本語の語に限定、重要度の高い順）

| 語 | 重要度(概算) | 解釈のメモ |
|----|-------------|------------|
| クリエイター | 0.0075 | 授業名・分野との共起 |
| オブジェクト | 0.0053 | プログラミング等の用語 |
| 偏見 | 0.0043 | 負の評価・批判的文脈 |
| 登山 | 0.0037 | 授業テーマとの共起 |
| 熱い | 0.0035 | 文脈依存（不満・負荷など） |
| 戦時 | 0.0034 | 授業内容・歴史系 |
| 魅了 | 0.0032 | 文脈次第で肯定にも否定にも |
| 苦しむ | 0.0030 | 負の感情 |
| ひど | 0.0028 | 不満・負の評価 |
| 馴染み | 0.0028 | 馴染みがない等の否定で共起しうる |
| 配属 | 0.0027 | 配属先・環境への言及 |
| チームメイト | 0.0022 | 人間関係・グループ |
| 格差 | 0.0022 | 不満・社会批判 |
| 消える | 0.0021 | ネガティブな変化 |
| 高圧 | 0.0021 | 負の印象（P2・P4 共通要因） |
| ゼミ | 0.0020 | 授業タイプ |
| ゴミ | 0.00185 | 強い否定的語 |
| 迷い | 0.00179 | 不安・不満 |
| プログラミング | 0.00174 | 分野・授業名 |
| 退屈 | 0.00100 | 明確な不満 |
| 不便 | 0.00093 | 不満 |
| 下手 | 0.00093 | 否定的評価 |
| 文句 | 0.00092 | 不満の表明 |
| 嫌 | 0.00085 | 否定的感情 |
| 批判 | 0.00073 | 否定的評価 |
| 残念 | 0.00059 | 不満・残念 |
| 難しかっ | 0.00063 | 困難 |
| 未熟 | 0.00070 | 否定的評価 |

### 4.4 P4（高評価確率）に寄与する語

- P4 の SHAP 重要度の**最大値は約 0.00054**で、**P2 の約 1/10〜1/15** 程度。高評価に「特に効く」語は本データ・モデルでは P2 ほど明確には分離されなかった。
- **上位語**: 圏、高圧、無、句、慣用、唱、拒否、見下、ヵ月、妙、出典、要請、拠点、佐竹、妄想、要人、エレクトロニクス など。単体では解釈しにくい語や文脈依存の語が多い。
- **「否定形で肯定」の可能性**: 拒否、見下、偏見 は「拒否感がない」「見下さない」「偏見がない」のように否定形で使われると高評価の記述と共起しうる。
- **ポジティブ・肯定文脈らしい語（中位以降）**: 楽し、面白、楽しい、恵まれ、易い、役立っ、理想、進歩。高評価の自由記述で使われやすい語と整合的である。ただし重要度は P2 の不満語に比べて小さい。

#### 表：P4 に寄与する語の例（意味のある日本語の語に限定）

| 語 | 重要度(概算) | 解釈のメモ |
|----|-------------|------------|
| 圏 | 0.00054 | 単体では解釈困難（P2・P4 共通要因） |
| 高圧 | 0.00053 | P2・P4 両方で上位、文脈次第で両義的 |
| 無 | 0.00041 | 無理がない、無駄がない等の肯定文脈の可能性 |
| 句・慣用 | 0.00039 | 慣用句・授業内容との共起 |
| 拒否 | 0.00036 | 「拒否感がない」等の否定形で肯定文脈になりうる |
| 見下 | 0.00034 | 「見下さない」等の否定形で肯定文脈になりうる |
| 掴み | 0.00017 | 「掴みやすい」等の肯定文脈の可能性 |
| はじめる | 0.00017 | わかりやすくはじまる、等 |
| 馴染み | 0.00016 | 「馴染みやすい」等の肯定文脈の可能性 |
| チームメイト | 0.00016 | 人間関係の肯定的文脈の可能性 |
| 楽し | 0.00011 | ポジティブ語（楽しめる、楽しかった） |
| 面白 | 0.000091 | ポジティブ語 |
| 楽しい | 0.000077 | ポジティブ語 |
| 恵まれ | 0.000073 | ポジティブ語（恵まれている） |
| 易い | 0.000055 | 「わかりやすい」等の肯定文脈 |
| 役立っ | 0.000097 | 「役立つ」（高評価と整合） |

### 4.5 授業改善への示唆

- **P2（低評価に寄与する語）が多く出現する記述や授業**を重点的に見直すことで、「2点を減らす」改善候補を洗い出しうる。
- 順序回帰モデルと SHAP を組み合わせることで、**平均評価を上げる（とくに低評価を減らす）ための語レベルの手がかり**が得られることが示された。
- 施策面では、**P2 の「低評価に寄与する語」を減らす**ことを優先し、P4 の語は「高評価の記述で使われやすい語」の手がかりとして補助的に参照するのが現実的である。

---

## 5. 図・表のキャプションとファイル参照（論文にそのまま使える形）

### 5.1 表のキャプション案

- **表1** 順序回帰 SHAP 分析の概要（背景サンプル 1,000 件、語彙数 7,795）。P2：中低評価確率、P4：高評価確率への語単位 SHAP 重要度を算出し、強い共通要因・P2 特化・P4 特化に分類した。
- **表2** 強い共通要因（P2・P4 の両方で重要度が高い語）。高圧、圏の 2 語。
- **表3** P2（中低評価確率）に寄与する語の例（意味のある日本語の語に限定、重要度の高い順）。断片・subword は除いた。
- **表4** P4（高評価確率）に寄与する語の例（意味のある日本語の語に限定）。上位〜中位。

### 5.2 図のキャプション案とファイルパス

| 図番号 | キャプション案 | ファイル（相対パス） |
|--------|----------------|----------------------|
| 図1 | P2（中低評価確率）に寄与する語の SHAP 重要度 Top 30 | `その他/03_分析結果/順序回帰SHAP分析_P2P4/p2_top30_factors_production.png` |
| 図2 | P4（高評価確率）に寄与する語の SHAP 重要度 Top 30 | `その他/03_分析結果/順序回帰SHAP分析_P2P4/p4_top30_factors_production.png` |
| 図3 | P2・P4 の重要語の比較 | `その他/03_分析結果/順序回帰SHAP分析_P2P4/p2_p4_comparison_production.png` |
| 図4 | 要因のカテゴリ別件数（強い共通・P2 特化・P4 特化など） | `その他/03_分析結果/順序回帰SHAP分析_P2P4/factor_categories_chart_production.png` |

---

## 6. 考察（論文の「考察」節に書く内容）

- 順序回帰モデルの**クラス確率（P2・P4）**に対して SHAP 分析を行うことで、「低評価を減らす要因」と「高評価を増やす要因」を**語レベル**で検討できることを示した。
- P2 に寄与する語には**不満・困難・否定的評価**を表す語が多く含まれ、モデルの解釈可能性と実務的な有用性が両立しうることが示唆された。
- P4 に寄与する語は重要度が低く、かつ単体では解釈しにくい語が多かった。サンプル数・質問項目・授業群の偏りなどの影響が考えられ、今後のデータ拡充や、高評価記述に特化した分析が有用である。
- 「高圧」「圏」は P2・P4 の両方で重要度が高く、記述の文脈によって低評価・高評価のいずれにも関与しうる**共通要因**と解釈できる。

---

## 7. 限界（論文の「限界」または「考察」内に書く内容）

- SHAP 重要度は**相関**であり、因果関係を示すものではない。
- トークン単位（WordPiece）のため、同一語の複数トークンは別扱いであり、**語単位で集約すると順位が変わる**可能性がある。
- 背景サンプル 1,000 件で固定しており、**サンプル変更による安定性は未検証**である。
- ポジティブ語が P2 に寄与しているように見える語については、**否定形での共起の有無を生テキストで確認していない**。
- P4 の重要度は P2 より約 1 桁小さく、**ノイズの影響を受けやすく、解釈は P2 より慎重に行う必要がある**。

---

## 8. 論文で参照するファイル一覧（図・表・データの出典）

| 用途 | ファイル名（その他/03_分析結果/順序回帰SHAP分析_P2P4/ 以下） |
|------|-------------------------------------------------------------|
| P2 重要語 Top30 の図 | `p2_top30_factors_production.png` |
| P4 重要語 Top30 の図 | `p4_top30_factors_production.png` |
| P2・P4 比較図 | `p2_p4_comparison_production.png` |
| カテゴリ別件数図 | `factor_categories_chart_production.png` |
| P2 語リスト（全語） | `word_importance_p2中低評価確率_production.csv` |
| P4 語リスト（全語） | `word_importance_p4高評価確率_production.csv` |
| P2 Top100 | `word_importance_p2_top100_production.csv` |
| P4 Top100 | `word_importance_p4_top100_production.csv` |
| 数値サマリ（JSON） | `analysis_summary_production.json` |
| 分析結果サマリ（Markdown） | `ordinal_shap_analysis_summary_production.md` |

---

## 9. 方法の1文（論文の「方法」節で使う短文）

> 授業評価の順序回帰モデル（CORAL 型・LLP 損失）に対し、自由記述テキストを入力としたときの予測（P2：中低評価確率、P4：高評価確率）について、SHAP（Lundberg & Lee, 2017）により語単位の重要度を算出した。背景サンプル 1,000 件、語彙数 7,795 語を対象とした。

---

**以上で、論文執筆に必要な方法・結果・図表・考察・限界・引用・ファイル参照を一括で記載した。本文では必要に応じて番号・表現を調整して使用すること。**
